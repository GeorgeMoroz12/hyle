---
// src/pages/catalog.astro
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import { getCollection } from 'astro:content';

// 1. ЗАГРУЗКА СПРАВОЧНИКОВ (Для перевода ID -> Название)
const allCategories = await getCollection('categories');
const allTags = await getCollection('tags');

// Словари
const categoryMap = new Map(allCategories.map(c => [c.id, c.data.title]));
const tagMap = new Map(allTags.map(t => [t.id, t.data.title]));

const resolveId = (item: any) => {
    if (!item) return null;
    if (typeof item === 'string') return item;
    if (typeof item === 'object' && item.id) return item.id;
    return null;
};

// 2. СБОР ТОВАРОВ
const allProducts = await getCollection('products', ({ data }) => {
    return data.status !== 'archived';
});
const sortedProducts = allProducts.sort((a, b) => 0);

// 3. СБОР ФИЛЬТРОВ
const usedCategoryIds = new Set(sortedProducts.map(p => resolveId(p.data.category)).filter(Boolean));

const rawTagIds = allProducts.flatMap(p => {
    const tags = p.data.tags || [];
    return tags.map(resolveId);
}).filter(t => t && typeof t === 'string' && t.trim() !== '');

const uniqueTagIds = [...new Set(rawTagIds)];

// ФОРМИРОВАНИЕ ЧИСТЫХ СПИСКОВ ДЛЯ РЕНДЕРА
// Категории
const filterCategories = allCategories
    .filter(cat => usedCategoryIds.has(cat.id))
    .map(cat => ({ 
        id: cat.id, 
        title: cat.data.title // Русское название
    }))
    .sort((a, b) => a.title.localeCompare(b.title));

// Теги
const filterTags = uniqueTagIds.map(id => {
    // Ищем в словаре или используем ID с большой буквы
    const title = tagMap.get(id) || (id.charAt(0).toUpperCase() + id.slice(1));
    return { id, title }; // Возвращаем чистый объект
}).sort((a, b) => a.title.localeCompare(b.title));

const pageTitle = "Каталог";
const pageDesc = "Полная коллекция керамики ручной работы Hyle.";
---

<Layout title={pageTitle} description={pageDesc}>
  
  <div class="min-h-screen pt-16 md:pt-20 pb-20 bg-hyle-bg transition-colors duration-500">
    <!-- HEADER: компактно, без декоративных линий -->
    <div class="container-main">
        <div class="flex flex-col items-center text-center gap-4 mb-10 animate-appear">
            <h1 class="font-serif text-4xl md:text-6xl text-hyle-text leading-[1.05] tracking-tight">
                Керамика
            </h1>
            <p class="text-hyle-text/60 font-sans font-light max-w-md text-base md:text-lg leading-relaxed">
                Вещи, хранящие тепло рук.<br/>
                Найдите то, что откликается именно вам.
            </p>
        </div>
    </div>

    <!-- FILTERS: во всю ширину блока с товарами (тот же container-main) -->
    <div class="sticky top-0 z-40 bg-hyle-bg py-4 md:py-6 mb-10 transition-all w-full" id="filter-bar">
        <div class="container-main">
            <div class="flex flex-col gap-5">
                <!-- LEVEL 1: CATEGORIES — на мобиле скролл во весь экран -->
                <div class="w-screen max-w-[100vw] ml-[calc(-50vw+50%)] md:w-full md:ml-0 pb-2">
                    <div class="flex flex-nowrap gap-6 overflow-x-auto scrollbar-hide overscroll-x-contain px-5 md:px-0 md:flex-wrap md:justify-center md:gap-8 md:overflow-visible">
                        <button 
                            class="filter-btn group pb-1 shrink-0 transition-all duration-300 text-lg md:text-xl font-serif"
                            data-type="category"
                            data-value="all"
                            data-active-class="text-hyle-text border-b border-hyle-text"
                            data-inactive-class="text-hyle-text/40 hover:text-hyle-clay border-b border-transparent"
                        >
                            Все
                        </button>

                        {filterCategories.map(cat => (
                            <button 
                                class="filter-btn group pb-1 shrink-0 transition-all duration-300 text-lg md:text-xl font-serif"
                                data-type="category"
                                data-value={cat.id} 
                                data-active-class="text-hyle-text border-b border-hyle-text"
                                data-inactive-class="text-hyle-text/40 hover:text-hyle-clay border-b border-transparent"
                            >
                                {cat.title}
                            </button>
                        ))}
                    </div>
                </div>

                <!-- LEVEL 2: TAGS — на мобиле скролл во весь экран -->
                {filterTags.length > 0 && (
                    <div class="w-screen max-w-[100vw] ml-[calc(-50vw+50%)] md:w-full md:ml-0 md:flex md:justify-center">
                        <div class="flex flex-nowrap gap-3 overflow-x-auto scrollbar-hide overscroll-x-contain px-5 md:px-0 md:flex-wrap md:justify-center md:overflow-visible">
                            {filterTags.map(tag => (
                                <button 
                                    class="filter-btn group shrink-0 px-4 py-1.5 rounded-full border transition-all duration-300 text-[11px] lowercase tracking-wide font-mono"
                                    data-type="tag"
                                    data-value={tag.id} 
                                    data-active-class="bg-hyle-text text-hyle-bg border-hyle-text"
                                    data-inactive-class="bg-transparent text-hyle-text/50 border-hyle-text/10 hover:border-hyle-clay hover:text-hyle-clay"
                                >
                                    {tag.title}
                                </button>
                            ))}
                        </div>
                    </div>
                )}
            </div>
            
                <div id="active-filters-info" class="hidden mt-4 text-center">
                    <button id="reset-all" class="text-[10px] uppercase tracking-widest text-hyle-text/40 hover:text-hyle-clay border-b border-current pb-0.5 transition-colors">
                        Сбросить фильтры
                    </button>
                </div>
            </div>
        </div>

    <!-- GRID -->
    <div class="container-main">
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-5 gap-y-12 md:gap-x-8 md:gap-y-16 min-h-[50vh]">
            
            {sortedProducts.map((product) => {
                const catId = resolveId(product.data.category);
                
                // Подготовка строки тегов для фильтрации
                const tagsRaw = product.data.tags || [];
                const tagIds = tagsRaw.map(resolveId).filter(Boolean);
                const tagsString = tagIds.join(',');
                
                // Получаем название категории для карточки
                const catName = catId ? (categoryMap.get(catId) || '') : '';
                
                return (
                    <div 
                        class="product-item transition-all duration-700 opacity-100 translate-y-0"
                        data-category={catId}
                        data-tags={tagsString}
                    >
                        <ProductCard 
                            product={product} 
                            categoryName={catName} 
                        />
                    </div>
                );
            })}

            <div id="empty-state" class="hidden col-span-full py-20 text-center">
                <p class="font-serif text-2xl text-hyle-text/40 mb-4">Пустота</p>
                <button onclick="document.getElementById('reset-all').click()" class="text-xs uppercase tracking-widest border-b border-hyle-clay text-hyle-clay">
                    Показать всё
                </button>
            </div>
        </div>

    </div>
  </div>
</Layout>

<script>
    document.addEventListener('astro:page-load', initCatalog);
    if (document.readyState === 'complete') initCatalog();
    else window.addEventListener('load', initCatalog);

    function initCatalog() {
        const productItems = document.querySelectorAll('.product-item');
        const btns = document.querySelectorAll('.filter-btn');
        const emptyState = document.getElementById('empty-state');
        const resetAllBtn = document.getElementById('reset-all');
        const infoPanel = document.getElementById('active-filters-info');

        let activeCategories = new Set();
        let activeTags = new Set();

        const params = new URLSearchParams(window.location.search);
        if (params.has('categories')) params.get('categories').split(',').forEach(c => { if(c) activeCategories.add(c); });
        if (params.has('tags')) params.get('tags').split(',').forEach(t => { if(t) activeTags.add(t); });
        if (params.has('tag')) activeTags.add(params.get('tag'));

        render();

        btns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const type = btn.getAttribute('data-type');
                const value = btn.getAttribute('data-value');

                if (value === 'all') {
                    activeCategories.clear();
                } else if (type === 'category') {
                    activeCategories.clear();
                    activeCategories.add(value);
                } else {
                    if (activeTags.has(value)) activeTags.delete(value);
                    else activeTags.add(value);
                }
                
                updateURL();
                render();
            });
        });

        if (resetAllBtn) {
            resetAllBtn.addEventListener('click', () => {
                activeCategories.clear();
                activeTags.clear();
                updateURL();
                render();
            });
        }

        function render() {
            btns.forEach(btn => {
                const type = btn.getAttribute('data-type');
                const value = btn.getAttribute('data-value');
                const activeClass = btn.getAttribute('data-active-class');
                const inactiveClass = btn.getAttribute('data-inactive-class');
                
                let isActive = false;
                if (value === 'all') isActive = activeCategories.size === 0;
                else isActive = type === 'category' ? activeCategories.has(value) : activeTags.has(value);

                // Восстанавливаем классы, не теряя стили (shrink-0 нужен для горизонтального скролла на мобиле)
                let baseClasses = "filter-btn group shrink-0 transition-all duration-300 whitespace-nowrap cursor-pointer";
                if (type === 'category') baseClasses += " pb-1 text-lg md:text-xl font-serif";
                else baseClasses += " px-4 py-1.5 rounded-full border text-[11px] lowercase tracking-wide font-mono";
                
                btn.className = `${baseClasses} ${isActive ? activeClass : inactiveClass}`;
            });

            let visibleCount = 0;
            productItems.forEach(item => {
                const pCat = item.getAttribute('data-category');
                const pTags = item.getAttribute('data-tags') ? item.getAttribute('data-tags').split(',') : [];

                const catMatch = activeCategories.size === 0 || activeCategories.has(pCat);
                const tagMatch = activeTags.size === 0 || pTags.some(t => activeTags.has(t));

                if (catMatch && tagMatch) {
                    item.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        // @ts-ignore
                        item.style.opacity = '1';
                        // @ts-ignore
                        item.style.transform = 'translateY(0)';
                    });
                    visibleCount++;
                } else {
                    // @ts-ignore
                    item.style.opacity = '0';
                    // @ts-ignore
                    item.style.transform = 'translateY(20px)';
                    item.classList.add('hidden');
                }
            });

            if (visibleCount === 0) emptyState.classList.remove('hidden');
            else emptyState.classList.add('hidden');

            if (activeCategories.size > 0 || activeTags.size > 0) infoPanel.classList.remove('hidden');
            else infoPanel.classList.add('hidden');
        }

        function updateURL() {
            const url = new URL(window.location.href);
            url.searchParams.delete('tag');
            url.searchParams.delete('categories');
            url.searchParams.delete('tags');

            if (activeCategories.size > 0) url.searchParams.set('categories', Array.from(activeCategories).join(','));
            if (activeTags.size > 0) url.searchParams.set('tags', Array.from(activeTags).join(','));
            
            window.history.pushState({}, '', url);
        }
    }
</script>