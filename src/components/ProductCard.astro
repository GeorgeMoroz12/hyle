---
// src/components/ProductCard.astro
import type { CollectionEntry } from 'astro:content';
import { getEntries } from 'astro:content';

interface Props {
  product: CollectionEntry<'products'>;
}

const { product } = Astro.props;
const { title, price, images, status, tags } = product.data;

const mainImage = images && images.length > 0 ? images[0] : '/images/placeholder.jpg';
// Форматируем цену как "код": 4.500 RUB
const formattedPrice = price > 0 
    ? `${price.toLocaleString('ru-RU')} RUB` 
    : 'ON REQUEST';

const s = status?.toLowerCase() || '';
const isSold = s === 'sold' || s === 'продано';

// --- DATA LOGIC (Safe) ---
// Оставляем безопасную логику получения данных, меняем только визуал
let visibleTags = [];
const rawTags = tags;
if (Array.isArray(rawTags) && rawTags.length > 0) {
  const validTags = rawTags.filter(tag => tag !== null && tag !== undefined);
  if (validTags.length > 0) {
    try {
      visibleTags = await getEntries(validTags);
    } catch (e) {
      console.warn(e);
    }
  }
}

const productUrl = `/products/${product.slug}`;
---

<div class="group relative w-full flex flex-col gap-4">
  
  <!-- 1. IMAGE: RAW & GRAINY -->
  <a href={productUrl} class="block relative aspect-[4/5] overflow-hidden bg-[#111]">
    
    <!-- Status Stamp -->
    {(isSold) && (
      <div class="absolute top-4 left-0 z-30 bg-hyle-text text-hyle-ink px-3 py-1 font-stamp text-xs font-bold -rotate-2 mix-blend-hard-light">
         SOLD OUT
      </div>
    )}

    <!-- Image with Filters -->
    <!-- Grayscale по умолчанию, цвет при ховере. Scale резкий. -->
    <img 
      src={mainImage} 
      alt={title} 
      loading="lazy"
      class={`
        w-full h-full object-cover object-center 
        transition-all duration-500 ease-out
        grayscale group-hover:grayscale-0 
        group-hover:scale-105
        ${isSold ? 'opacity-50' : 'opacity-90'}
      `}
    />
    
    <!-- Inner Border (Рамка внутри фото, как на негативе) -->
    <div class="absolute inset-0 border border-white/10 pointer-events-none group-hover:border-white/30 transition-colors"></div>
  </a>

  <!-- 2. INFO: TECHNICAL & BRUTAL -->
  <div class="flex flex-col gap-3">
    
    <!-- Header -->
    <div class="flex justify-between items-start border-b border-white/20 pb-3">
        <a href={productUrl} class="block max-w-[70%]">
            <h3 class="font-sans font-black text-xl leading-none text-hyle-text uppercase hover:text-white transition-colors">
              {title}
            </h3>
        </a>
        <span class="font-stamp text-sm text-hyle-text/60">
            {/* Генерация фейкового артикула для стиля, или ID */}
            #{product.slug.substring(0, 4).toUpperCase()}
        </span>
    </div>

    <!-- Details Grid -->
    <div class="flex justify-between items-end">
        <div class="flex flex-col gap-1">
            <!-- Tags as Technical Specs -->
            {visibleTags.length > 0 && (
                <div class="flex gap-2">
                    {visibleTags.slice(0, 2).map(tag => (
                        <span class="font-stamp text-[10px] text-hyle-text/50 uppercase">
                            [{tag.data.title}]
                        </span>
                    ))}
                </div>
            )}
            <span class="font-stamp text-lg text-hyle-text font-bold tracking-tighter">
                {formattedPrice}
            </span>
        </div>

        <!-- THE STROKE BUTTON -->
        <!-- Рваный край через clip-path -->
        {!isSold && (
            <a 
                href={productUrl}
                class="rough-edge bg-hyle-accent text-hyle-ink px-6 py-3 font-stamp text-xs font-bold uppercase hover:bg-white transition-colors"
            >
                Add +
            </a>
        )}
    </div>

  </div>
</div>