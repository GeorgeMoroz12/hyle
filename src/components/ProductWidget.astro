---
// src/components/ProductWidget.astro
import { getEntry } from 'astro:content';

interface Props {
  // ВАЖНО: Имя пропа должно совпадать с полем в Keystatic (product)
  product: string; 
}

// Переименовываем для удобства внутри, но принимаем 'product'
const { product: productId } = Astro.props;

let productEntry = null;

if (productId && typeof productId === 'string') {
    try {
        productEntry = await getEntry('products', productId);
    } catch (e) {
        console.warn(`ProductWidget: Product '${productId}' not found.`);
    }
}

if (!productEntry) return null;

const { title, price, images, status } = productEntry.data;
const mainImage = images && images.length > 0 ? images[0] : '/images/placeholder.jpg';
const formattedPrice = price > 0 ? `${price.toLocaleString('ru-RU')} ₽` : 'По запросу';
const isSold = status === 'sold' || status === 'продано';
---

<div class="my-12 w-full max-w-2xl mx-auto not-prose">
    <div class="relative flex flex-col sm:flex-row bg-hyle-surface border border-hyle-text/5 rounded-sm overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-500">
        
        <a href={`/products/${productEntry.slug}`} class="block w-full sm:w-1/3 aspect-[4/3] sm:aspect-auto relative group overflow-hidden">
            <img 
                src={mainImage} 
                alt={title} 
                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
            />
            {isSold && (
                <div class="absolute inset-0 bg-white/40 flex items-center justify-center">
                    <span class="text-[10px] uppercase tracking-widest bg-white px-2 py-1 font-mono">Продано</span>
                </div>
            )}
        </a>

        <div class="flex-1 p-6 flex flex-col justify-between items-start gap-4">
            <div>
                <span class="font-mono text-[10px] uppercase tracking-widest text-hyle-text/40 mb-2 block">
                    Упомянуто в статье
                </span>
                <a href={`/products/${productEntry.slug}`} class="block">
                    <h3 class="font-serif text-xl md:text-2xl text-hyle-text leading-tight hover:text-hyle-clay transition-colors">
                        {title}
                    </h3>
                </a>
            </div>

            <div class="w-full flex items-end justify-between border-t border-hyle-text/5 pt-4 mt-2">
                <div class="flex flex-col">
                    <span class="font-hand text-2xl text-hyle-clay -rotate-2 origin-left">
                        {formattedPrice}
                    </span>
                </div>

                <a 
                    href={`/products/${productEntry.slug}`} 
                    class="group flex items-center gap-2 font-mono text-[11px] uppercase tracking-widest text-hyle-text hover:text-hyle-clay transition-colors"
                >
                    Смотреть
                    <span class="text-lg font-serif italic relative top-[-1px] group-hover:translate-x-1 transition-transform">→</span>
                </a>
            </div>
        </div>

    </div>
</div>