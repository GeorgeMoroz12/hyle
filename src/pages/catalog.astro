---
// src/pages/catalog.astro
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import { getCollection, getEntries } from 'astro:content';

// --- 1. ЗАГРУЗКА СПРАВОЧНИКОВ (Русские названия) ---
const allCategories = await getCollection('categories');
const allTagsCollection = await getCollection('tags');

// Создаем Map для быстрого перевода ID -> Русское название
const categoryMap = allCategories.reduce((acc, cat) => {
    acc[cat.id] = cat.data.title;
    return acc;
}, {} as Record<string, string>);

const tagMap = allTagsCollection.reduce((acc, tag) => {
    acc[tag.id] = tag.data.title;
    return acc;
}, {} as Record<string, string>);

// --- 2. ЗАГРУЗКА ТОВАРОВ И НОРМАЛИЗАЦИЯ ДАННЫХ ---
const allProducts = await getCollection('products', ({ data }) => {
    return data.status !== 'archived';
});

// Сортировка: новые сверху (опционально)
const sortedProducts = allProducts.sort((a, b) => 0);

// Хелпер: извлекает чистый ID из смешанных данных (String | Reference)
const resolveId = (item: any) => {
    if (!item) return null;
    if (typeof item === 'string') return item; // Legacy
    if (typeof item === 'object' && item.id) return item.id; // New Reference
    return null;
};

// --- 3. СБОР АКТИВНЫХ ФИЛЬТРОВ (Только те, что есть у товаров) ---
// Собираем ID категорий, которые реально используются в товарах
const usedCategoryIds = new Set(sortedProducts.map(p => resolveId(p.data.category)).filter(Boolean));

// Собираем ID тегов
const usedTagIds = new Set(sortedProducts.flatMap(p => {
    const tags = p.data.tags || [];
    return tags.map(resolveId).filter(Boolean);
}));

// Формируем массивы для рендера кнопок (ID + Title)
const filterCategories = allCategories
    .filter(cat => usedCategoryIds.has(cat.id))
    .map(cat => ({ id: cat.id, title: cat.data.title }))
    .sort((a, b) => a.title.localeCompare(b.title));

const filterTags = allTagsCollection
    .filter(tag => usedTagIds.has(tag.id))
    .map(tag => ({ id: tag.id, title: tag.data.title }))
    .sort((a, b) => a.title.localeCompare(b.title));

const pageTitle = "Каталог";
const pageDesc = "Полная коллекция керамики ручной работы Hyle.";
---

<Layout title={pageTitle} description={pageDesc}>
  
  <div class="min-h-screen pt-24 md:pt-32 pb-20 bg-[#FDFCF8]">
    <div class="container-main">
        
        <!-- HEADER -->
        <div class="flex flex-col items-start gap-4 mb-12 animate-appear">
            <h1 class="font-serif text-4xl md:text-6xl text-hyle-text leading-[0.9]">
                Каталог
            </h1>
            <p class="text-hyle-text/60 font-light max-w-md text-sm md:text-base">
                Используйте фильтры, чтобы найти свое изделие.
            </p>
        </div>

        <!-- FILTERS PANEL (Sticky) -->
        <div class="sticky top-0 z-40 bg-[#FDFCF8]/95 backdrop-blur-md py-4 mb-12 border-b border-hyle-text/5 transition-all w-full -mx-4 px-4 md:mx-0 md:px-0">
            
            <div class="flex flex-col gap-4">
                
                <!-- ГРУППА 1: КАТЕГОРИИ (Основные) -->
                <div class="flex items-center gap-2 overflow-x-auto scrollbar-hide pb-1 mask-linear">
                    <span class="text-[10px] font-mono uppercase tracking-widest text-hyle-text/40 mr-2 shrink-0">Категории:</span>
                    
                    <button 
                        class="filter-btn group px-4 py-2 rounded-full border transition-all duration-300 whitespace-nowrap text-[11px] uppercase tracking-widest"
                        data-type="category"
                        data-value="all"
                        data-active-class="bg-hyle-text text-[#F9F8F6] border-hyle-text"
                        data-inactive-class="bg-transparent text-hyle-text/60 border-hyle-text/20 hover:border-hyle-clay hover:text-hyle-clay"
                    >
                        Все
                    </button>

                    {filterCategories.map(cat => (
                        <button 
                            class="filter-btn group px-4 py-2 rounded-full border transition-all duration-300 whitespace-nowrap text-[11px] uppercase tracking-widest"
                            data-type="category"
                            data-value={cat.id} 
                            data-active-class="bg-hyle-text text-[#F9F8F6] border-hyle-text"
                            data-inactive-class="bg-transparent text-hyle-text/60 border-hyle-text/20 hover:border-hyle-clay hover:text-hyle-clay"
                        >
                            {cat.title}
                        </button>
                    ))}
                </div>

                <!-- ГРУППА 2: ТЕГИ (Дополнительные) -->
                {filterTags.length > 0 && (
                    <div class="flex items-center gap-2 overflow-x-auto scrollbar-hide pb-1 mask-linear">
                        <span class="text-[10px] font-mono uppercase tracking-widest text-hyle-text/40 mr-2 shrink-0">Теги:</span>
                        
                        {filterTags.map(tag => (
                            <button 
                                class="filter-btn group px-3 py-1.5 rounded-sm border transition-all duration-300 whitespace-nowrap text-[11px] font-hand -rotate-1 hover:rotate-0"
                                data-type="tag"
                                data-value={tag.id} 
                                data-active-class="bg-hyle-clay/10 text-hyle-clay border-hyle-clay"
                                data-inactive-class="bg-transparent text-hyle-text/50 border-hyle-text/10 hover:border-hyle-clay hover:text-hyle-clay"
                            >
                                #{tag.title}
                            </button>
                        ))}
                    </div>
                )}
            </div>
            
            <!-- Индикатор сброса (появляется JS-ом) -->
            <div id="active-filters-info" class="hidden mt-3 text-[10px] font-mono text-hyle-text/40 flex gap-2 items-center">
                <span>Фильтры активны</span>
                <button id="reset-all" class="underline hover:text-hyle-clay cursor-pointer">Сбросить всё</button>
            </div>
        </div>

        <!-- PRODUCTS GRID -->
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-10 md:gap-x-8 md:gap-y-16 min-h-[50vh]">
            
            {sortedProducts.map((product) => {
                // Подготовка данных для фильтрации (data-attributes)
                const catId = resolveId(product.data.category);
                
                const tagsRaw = product.data.tags || [];
                const tagIds = tagsRaw.map(resolveId).filter(Boolean);
                
                return (
                    <div 
                        class="product-item transition-all duration-500 opacity-100 translate-y-0"
                        data-category={catId}
                        data-tags={tagIds.join(',')}
                    >
                        <ProductCard 
                            product={product} 
                            // Передаем русское название категории в карточку
                            categoryName={catId ? categoryMap[catId] : ''} 
                        />
                    </div>
                );
            })}

            <!-- Empty State -->
            <div id="empty-state" class="hidden col-span-full py-24 text-center">
                <p class="font-serif text-3xl text-hyle-text/40 mb-4">Пустота</p>
                <p class="font-mono text-xs text-hyle-text/30 mb-6">По выбранным фильтрам изделий не найдено.</p>
                <button onclick="document.getElementById('reset-all').click()" class="px-6 py-3 border border-hyle-text/20 hover:bg-hyle-text hover:text-white transition-colors text-xs uppercase tracking-widest rounded-sm">
                    Показать всё
                </button>
            </div>

        </div>

    </div>
  </div>
</Layout>

<script>
    document.addEventListener('astro:page-load', initCatalog);
    if (document.readyState === 'complete') initCatalog();
    else window.addEventListener('load', initCatalog);

    function initCatalog() {
        const productItems = document.querySelectorAll('.product-item');
        const btns = document.querySelectorAll('.filter-btn');
        const emptyState = document.getElementById('empty-state');
        const resetAllBtn = document.getElementById('reset-all');
        const infoPanel = document.getElementById('active-filters-info');

        // Состояние фильтров (Set для множественного выбора)
        let activeCategories = new Set(); // Пустой Set = выбрано "Все"
        let activeTags = new Set();

        // 1. Инициализация из URL
        const params = new URLSearchParams(window.location.search);
        
        if (params.has('categories')) {
            params.get('categories').split(',').forEach(c => activeCategories.add(c));
        }
        if (params.has('tags')) {
            params.get('tags').split(',').forEach(t => activeTags.add(t));
        }
        // Одиночный легаси параметр ?tag=...
        if (params.has('tag')) {
            activeTags.add(params.get('tag'));
        }

        render();

        // 2. Обработчики кликов
        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.getAttribute('data-type');
                const value = btn.getAttribute('data-value');

                if (value === 'all') {
                    // Сброс категории
                    activeCategories.clear();
                } else {
                    // Тоггл (включить/выключить)
                    const targetSet = type === 'category' ? activeCategories : activeTags;
                    if (targetSet.has(value)) {
                        targetSet.delete(value);
                    } else {
                        targetSet.add(value);
                    }
                }
                
                updateURL();
                render();
            });
        });

        if (resetAllBtn) {
            resetAllBtn.addEventListener('click', () => {
                activeCategories.clear();
                activeTags.clear();
                updateURL();
                render();
            });
        }

        // 3. Основная логика рендеринга
        function render() {
            // Обновляем кнопки
            btns.forEach(btn => {
                const type = btn.getAttribute('data-type');
                const value = btn.getAttribute('data-value');
                const activeClass = btn.getAttribute('data-active-class');
                const inactiveClass = btn.getAttribute('data-inactive-class');
                
                let isActive = false;
                if (value === 'all') {
                    isActive = activeCategories.size === 0; // "Все" активно, если сет пуст
                } else {
                    isActive = type === 'category' ? activeCategories.has(value) : activeTags.has(value);
                }

                btn.className = `filter-btn relative transition-all duration-300 ${isActive ? activeClass : inactiveClass} ${btn.className.split(' ').filter(c => !c.startsWith('bg-') && !c.startsWith('text-') && !c.startsWith('border-')).join(' ')}`;
            });

            // Показываем/скрываем товары
            let visibleCount = 0;
            productItems.forEach(item => {
                const pCat = item.getAttribute('data-category');
                const pTags = item.getAttribute('data-tags') ? item.getAttribute('data-tags').split(',') : [];

                // Логика: (Категория подходит ИЛИ категории не выбраны) И (Хотя бы один тег подходит ИЛИ теги не выбраны)
                const catMatch = activeCategories.size === 0 || activeCategories.has(pCat);
                
                // Для тегов: если выбрано несколько тегов, показываем товары, у которых есть ХОТЯ БЫ ОДИН из выбранных (OR logic within tags)
                // Если нужно STRICT AND (товар должен иметь ВСЕ выбранные теги) - логика будет другой. Обычно в e-commerce это OR.
                const tagMatch = activeTags.size === 0 || pTags.some(t => activeTags.has(t));

                if (catMatch && tagMatch) {
                    item.classList.remove('hidden');
                    visibleCount++;
                } else {
                    item.classList.add('hidden');
                }
            });

            // Empty State
            if (visibleCount === 0) emptyState.classList.remove('hidden');
            else emptyState.classList.add('hidden');

            // Панель сброса
            if (activeCategories.size > 0 || activeTags.size > 0) infoPanel.classList.remove('hidden');
            else infoPanel.classList.add('hidden');
        }

        function updateURL() {
            const url = new URL(window.location.href);
            
            // Очищаем старые
            url.searchParams.delete('tag');
            url.searchParams.delete('categories');
            url.searchParams.delete('tags');

            if (activeCategories.size > 0) {
                url.searchParams.set('categories', Array.from(activeCategories).join(','));
            }
            if (activeTags.size > 0) {
                url.searchParams.set('tags', Array.from(activeTags).join(','));
            }
            
            window.history.pushState({}, '', url);
        }
    }
</script>