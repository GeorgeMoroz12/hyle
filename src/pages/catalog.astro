---
// src/pages/catalog.astro
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import { getCollection, getEntries } from 'astro:content';

// 1. GLOBAL LOOKUP (FIXED FIELDS)
const allCategories = await getCollection('categories');
const allTags = await getCollection('tags');

// FIX: Используем .data.title
const categoryMap = new Map(allCategories.map(c => [c.id, c.data.title]));
const tagMap = new Map(allTags.map(t => [t.id, t.data.title]));

const resolveId = (item: any) => {
    if (!item) return null;
    if (typeof item === 'string') return item;
    if (typeof item === 'object' && item.id) return item.id;
    return null;
};

// 2. СБОР ТОВАРОВ
const allProducts = await getCollection('products', ({ data }) => {
    return data.status !== 'archived';
});

const sortedProducts = allProducts.sort((a, b) => 0);

// 3. СБОР АКТИВНЫХ ФИЛЬТРОВ
const usedCategoryIds = new Set(sortedProducts.map(p => resolveId(p.data.category)).filter(Boolean));

const rawTagIds = allProducts.flatMap(p => {
    const tags = p.data.tags || [];
    return tags.map(resolveId);
}).filter(t => t && t.trim() !== '');
const uniqueTagIds = [...new Set(rawTagIds)];

// Формируем списки для рендера
const filterCategories = allCategories
    .filter(cat => usedCategoryIds.has(cat.id))
    .map(cat => ({ id: cat.id, title: cat.data.title }))
    .sort((a, b) => a.title.localeCompare(b.title));

// Для тегов используем безопасный маппинг
let filterTags = uniqueTagIds.map(id => {
    const title = tagMap.get(id) || (id.charAt(0).toUpperCase() + id.slice(1));
    return { id, title };
});
filterTags.sort((a, b) => a.title.localeCompare(b.title));

const pageTitle = "Каталог";
const pageDesc = "Полная коллекция керамики ручной работы Hyle.";
---

<Layout title={pageTitle} description={pageDesc}>
  
  <!-- 
    FIX: Уменьшил pt (padding-top) с pt-32 до pt-28.
    Это минимально необходимый отступ, чтобы фильтры не налезли на логотип, 
    но при этом были максимально высоко.
  -->
  <div class="min-h-screen pt-28 pb-20 bg-[#FDFCF8]">
    <div class="container-main">
        
        <!-- HEADER REMOVED: Заголовок "Коллекция" удален полностью -->

        <!-- FILTERS BAR -->
        <!-- 
           Sticky top-0: При скролле панель прилипнет к верху экрана.
           Добавил pt-2, чтобы был воздух над кнопками при прилипании.
        -->
        <div class="sticky top-0 z-40 bg-[#FDFCF8]/95 backdrop-blur-sm py-4 mb-8 border-b border-hyle-text/5 transition-all w-full" id="filter-bar">
            
            <div class="flex flex-col gap-4">
                
                <!-- ГРУППА 1: КАТЕГОРИИ (Крупно, Serif) -->
                <div class="flex items-center gap-4 overflow-x-auto scrollbar-hide pb-1 mask-linear justify-center">
                    <button 
                        class="filter-btn group pb-1 transition-all duration-300 whitespace-nowrap text-lg font-serif"
                        data-type="category"
                        data-value="all"
                        data-active-class="text-hyle-text border-b-2 border-hyle-clay"
                        data-inactive-class="text-hyle-text/40 hover:text-hyle-clay border-b-2 border-transparent"
                    >
                        Все
                    </button>

                    {filterCategories.map(cat => (
                        <button 
                            class="filter-btn group pb-1 transition-all duration-300 whitespace-nowrap text-lg font-serif"
                            data-type="category"
                            data-value={cat.id} 
                            data-active-class="text-hyle-text border-b-2 border-hyle-clay"
                            data-inactive-class="text-hyle-text/40 hover:text-hyle-clay border-b-2 border-transparent"
                        >
                            {cat.title}
                        </button>
                    ))}
                </div>

                <!-- ГРУППА 2: ТЕГИ (Мелко, Mono, Pills) -->
                {filterTags.length > 0 && (
                    <div class="flex items-center gap-2 overflow-x-auto scrollbar-hide pb-1 justify-center">
                        {filterTags.map(tag => (
                            <button 
                                class="filter-btn group px-3 py-1 rounded-full border transition-all duration-300 whitespace-nowrap text-[10px] uppercase tracking-widest font-mono"
                                data-type="tag"
                                data-value={tag.id} 
                                data-active-class="bg-hyle-text text-[#F9F8F6] border-hyle-text"
                                data-inactive-class="bg-transparent text-hyle-text/50 border-hyle-text/10 hover:border-hyle-clay hover:text-hyle-clay"
                            >
                                #{tag.title}
                            </button>
                        ))}
                    </div>
                )}
            </div>

            <!-- Сброс -->
            <div id="active-filters-info" class="hidden mt-3 text-[10px] font-mono text-hyle-text/40 flex gap-2 items-center justify-center">
                <button id="reset-all" class="underline hover:text-hyle-clay cursor-pointer">Сбросить фильтры</button>
            </div>
        </div>

        <!-- PRODUCTS GRID -->
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-8 md:gap-x-8 md:gap-y-16 min-h-[50vh]">
            
            {sortedProducts.map((product) => {
                const catId = resolveId(product.data.category);
                
                const rawTags = product.data.tags || [];
                const tagIds = rawTags.map(resolveId).filter(Boolean);
                const tagsString = tagIds.join(',');
                
                // Передаем название категории в карточку (для надписи над заголовком)
                const catName = catId ? (categoryMap.get(catId) || '') : '';
                
                return (
                    <div 
                        class="product-item transition-all duration-700 opacity-100 translate-y-0"
                        data-category={catId}
                        data-tags={tagsString}
                    >
                        <ProductCard 
                            product={product} 
                            categoryName={catName} 
                        />
                    </div>
                );
            })}

            <div id="empty-state" class="hidden col-span-full py-20 text-center">
                <p class="font-serif text-2xl text-hyle-text/40 mb-4">Пока здесь пусто</p>
                <button onclick="document.getElementById('reset-all').click()" class="text-xs uppercase tracking-widest border-b border-hyle-clay text-hyle-clay">
                    Показать всё
                </button>
            </div>

        </div>

    </div>
  </div>
</Layout>

<script>
    document.addEventListener('astro:page-load', initCatalog);
    if (document.readyState === 'complete') initCatalog();
    else window.addEventListener('load', initCatalog);

    function initCatalog() {
        const productItems = document.querySelectorAll('.product-item');
        const btns = document.querySelectorAll('.filter-btn');
        const emptyState = document.getElementById('empty-state');
        const resetAllBtn = document.getElementById('reset-all');
        const infoPanel = document.getElementById('active-filters-info');

        let activeCategories = new Set();
        let activeTags = new Set();

        const params = new URLSearchParams(window.location.search);
        if (params.has('categories')) params.get('categories').split(',').forEach(c => activeCategories.add(c));
        if (params.has('tags')) params.get('tags').split(',').forEach(t => activeTags.add(t));
        if (params.has('tag')) activeTags.add(params.get('tag'));

        render();

        btns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const type = btn.getAttribute('data-type');
                const value = btn.getAttribute('data-value');

                if (value === 'all') {
                    activeCategories.clear();
                } else if (type === 'category') {
                    // ТАБЫ для категорий (только одна активна)
                    activeCategories.clear();
                    activeCategories.add(value);
                } else {
                    // ФИЛЬТРЫ для тегов (можно несколько)
                    if (activeTags.has(value)) activeTags.delete(value);
                    else activeTags.add(value);
                }
                
                updateURL();
                render();
            });
        });

        if (resetAllBtn) {
            resetAllBtn.addEventListener('click', () => {
                activeCategories.clear();
                activeTags.clear();
                updateURL();
                render();
            });
        }

        function render() {
            btns.forEach(btn => {
                const type = btn.getAttribute('data-type');
                const value = btn.getAttribute('data-value');
                const activeClass = btn.getAttribute('data-active-class');
                const inactiveClass = btn.getAttribute('data-inactive-class');
                
                let isActive = false;
                if (value === 'all') isActive = activeCategories.size === 0;
                else isActive = type === 'category' ? activeCategories.has(value) : activeTags.has(value);

                let baseClasses = "filter-btn group transition-all duration-300 whitespace-nowrap cursor-pointer";
                if (type === 'category') baseClasses += " pb-1 text-lg font-serif";
                else baseClasses += " px-3 py-1 rounded-full border text-[10px] uppercase tracking-widest font-mono";
                
                btn.className = `${baseClasses} ${isActive ? activeClass : inactiveClass}`;
            });

            let visibleCount = 0;
            productItems.forEach(item => {
                const pCat = item.getAttribute('data-category');
                const pTags = item.getAttribute('data-tags') ? item.getAttribute('data-tags').split(',') : [];

                const catMatch = activeCategories.size === 0 || activeCategories.has(pCat);
                const tagMatch = activeTags.size === 0 || pTags.some(t => activeTags.has(t));

                if (catMatch && tagMatch) {
                    item.classList.remove('hidden');
                    visibleCount++;
                } else {
                    item.classList.add('hidden');
                }
            });

            if (visibleCount === 0) emptyState.classList.remove('hidden');
            else emptyState.classList.add('hidden');

            if (activeCategories.size > 0 || activeTags.size > 0) infoPanel.classList.remove('hidden');
            else infoPanel.classList.add('hidden');
        }

        function updateURL() {
            const url = new URL(window.location.href);
            url.searchParams.delete('tag');
            url.searchParams.delete('categories');
            url.searchParams.delete('tags');

            if (activeCategories.size > 0) url.searchParams.set('categories', Array.from(activeCategories).join(','));
            if (activeTags.size > 0) url.searchParams.set('tags', Array.from(activeTags).join(','));
            
            window.history.pushState({}, '', url);
        }
    }
</script>