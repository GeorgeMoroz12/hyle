---
// src/components/ProductCard.astro
import type { CollectionEntry } from 'astro:content';
import { getEntries } from 'astro:content';

interface Props {
  product: CollectionEntry<'products'>;
  categoryName?: string;
}

const { product, categoryName } = Astro.props;
// FIX: Достаем маркетинговые поля
const { title, price, images, status, tags, isSale, oldPrice } = product.data;

const mainImage = images && images.length > 0 ? images[0] : '/images/placeholder.jpg';
const formattedPrice = price > 0 ? `${price.toLocaleString('ru-RU')} ₽` : 'По запросу';

const s = status?.toLowerCase() || '';
const isSold = s === 'sold' || s === 'продано';
const isReserved = s === 'reserved' || s === 'резерв';

// Логика Акции
const showSale = isSale && oldPrice && !isSold && !isReserved;

// --- ЛОГИКА ТЕГОВ ---
let visibleTags = [];
const rawTags = Array.isArray(tags) ? tags : [];

const tagIds = rawTags.map(t => {
    if (typeof t === 'string') return t;
    if (typeof t === 'object' && t?.id) return t.id;
    return null;
}).filter(t => t && t.trim() !== '');

if (tagIds.length > 0) {
    try {
        const tagRefs = tagIds.map(id => ({ collection: 'tags', id }));
        const loadedEntries = await getEntries(tagRefs);
        
        const namesMap = new Map();
        loadedEntries.forEach(entry => {
            if (entry && entry.data) {
                namesMap.set(entry.id, entry.data.title);
            }
        });

        visibleTags = tagIds.map(id => ({
            slug: id,
            label: namesMap.get(id) || (id.charAt(0).toUpperCase() + id.slice(1))
        }));

    } catch (e) {
        visibleTags = tagIds.map(id => ({ slug: id, label: id }));
    }
}

const displayTag = visibleTags.length > 0 ? visibleTags[0] : null;
const productUrl = `/products/${product.slug}`;
---

<div class="group relative w-full flex flex-col">
  
  <a href={productUrl} class="block relative overflow-hidden aspect-square bg-hyle-surface rounded-sm mb-3 cursor-pointer">
    <div class="absolute top-2 left-2 z-30 flex flex-col gap-1 items-start">
        {(isSold || isReserved) && (
        <span class="text-[9px] font-sans font-medium uppercase tracking-[0.2em] text-hyle-text px-2 py-1 bg-white/90 backdrop-blur-md border border-hyle-text/10 shadow-sm">
            {isSold ? 'Продано' : 'Резерв'}
        </span>
        )}
        
        <!-- АКЦИЯ -->
        {showSale && (
            <span class="text-[9px] font-sans font-bold uppercase tracking-[0.1em] text-white px-2 py-1 bg-[#B35A32] shadow-sm">
            Акция
            </span>
        )}
    </div>
    
    <img 
      src={mainImage} 
      alt={title} 
      loading="lazy"
      class={`w-full h-full object-cover object-center transition-transform duration-1000 ease-out-expo group-hover:scale-105 z-10 relative ${isSold ? 'grayscale opacity-90' : ''}`}
    />
  </a>

  <div class="flex justify-between items-start px-1 mt-auto">
    
    <div class="pr-2 flex flex-col items-start w-full min-w-0 relative">
        <a href={productUrl} class="block mb-0.5 w-full">
            <h3 class="font-serif text-base md:text-lg leading-normal text-hyle-text transition-colors duration-300 group-hover:text-hyle-clay line-clamp-2 pb-1.5 -mb-1.5">
              {title}
            </h3>
        </a>
        
        {displayTag && (
            <a 
                href={`/catalog?tag=${displayTag.slug}`}
                class="inline-block text-[11px] md:text-[13px] font-hand text-hyle-text/50 hover:text-hyle-clay transition-colors -rotate-2 hover:rotate-0 mt-0 relative z-20 lowercase"
            >
                #{displayTag.label.toLowerCase()}
            </a>
        )}
    </div>
    
    <div class="flex flex-col items-end shrink-0 pl-1 pt-1">
        {showSale ? (
            <span class="font-hand text-lg md:text-2xl text-[#B35A32] font-medium whitespace-nowrap -rotate-2 group-hover:rotate-0 transition-transform origin-center">
            {formattedPrice}
            </span>
        ) : (
            <span class="font-hand text-lg md:text-2xl text-hyle-clay font-medium whitespace-nowrap -rotate-2 group-hover:rotate-0 transition-transform origin-center">
            {formattedPrice}
            </span>
        )}
    </div>

  </div>
</div>