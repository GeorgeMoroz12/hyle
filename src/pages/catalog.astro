---
// src/pages/catalog.astro
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import { getCollection, getEntries } from 'astro:content';

// 1. ПОЛУЧЕНИЕ КАТЕГОРИЙ (Для маппинга в карточках)
// getCollection безопасен, так как читает сами файлы категорий, а не ссылки из товаров
const allCategories = await getCollection('categories');
const categoryMap = allCategories.reduce((acc, cat) => {
    acc[cat.id] = cat.data.title;
    return acc;
}, {} as Record<string, string>);

// 2. ПОЛУЧЕНИЕ ТОВАРОВ
const allProducts = await getCollection('products', ({ data }) => {
    return data.status !== 'archived';
});

// Сортировка (новые сверху)
const sortedProducts = allProducts.sort((a, b) => 0);

// 3. БЕЗОПАСНЫЙ СБОР ТЕГОВ (DEFENSIVE CODING)
// Нам нужно собрать уникальные ID тегов, которые используются в товарах,
// а затем получить их красивые названия (Title) из коллекции tags.

// Шаг А: Извлекаем ID (учитываем, что это может быть String или Reference Object)
const rawTagIds = allProducts.flatMap(product => {
    const tags = product.data.tags || [];
    return tags.map(tag => {
        // Если это объект-ссылка (Relation), берем .id, иначе саму строку
        return (typeof tag === 'object' && tag !== null) ? tag.id : tag;
    });
});

// Шаг Б: Чистим от мусора (null, undefined, пустые строки)
const cleanTagIds = [...new Set(rawTagIds)].filter(id => 
    id && typeof id === 'string' && id.trim() !== ''
);

// Шаг В: Безопасно запрашиваем данные тегов
let uniqueTags = []; // Массив объектов { id, title }

if (cleanTagIds.length > 0) {
    try {
        // Формируем правильные объекты references для getEntries
        const tagReferences = cleanTagIds.map(id => ({ collection: 'tags', id }));
        const tagEntries = await getEntries(tagReferences);
        
        // Мапим в удобный формат для UI
        uniqueTags = tagEntries.map(t => ({
            id: t.id,
            title: t.data.title // Название тега ("Новинка", "Sale")
        }));
    } catch (e) {
        console.warn('⚠️ Catalog: Failed to fetch filter tags. Using fallback IDs.', e);
        // Fallback: Если запрос упал, используем ID как название
        uniqueTags = cleanTagIds.map(id => ({ id, title: id }));
    }
}

const pageTitle = "Каталог";
const pageDesc = "Полная коллекция керамики ручной работы Hyle.";
---

<Layout title={pageTitle} description={pageDesc}>
  
  <div class="min-h-screen pt-20 md:pt-24 pb-20 bg-[#FDFCF8]">
    <div class="container-main">
        
        <!-- HEADER -->
        <div class="flex flex-col items-start gap-3 md:gap-4 mb-8 md:mb-12 animate-appear">
            <span class="text-[9px] md:text-[10px] uppercase tracking-[0.3em] text-hyle-text/40 pl-1">
                Shop All
            </span>
            <h1 class="font-serif text-4xl md:text-5xl lg:text-7xl text-hyle-text leading-[0.9]">
                Коллекция
            </h1>
            <p class="text-hyle-text/60 font-light max-w-md mt-1 text-sm md:text-base">
                Все изделия, доступные к заказу.
            </p>
        </div>

        <!-- FILTERS BAR -->
        <div class="sticky top-0 z-40 bg-[#FDFCF8]/95 backdrop-blur-sm py-4 mb-8 md:mb-12 border-b border-hyle-text/5 transition-all w-full" id="filter-bar">
            
            <div class="flex items-center gap-2 md:gap-3 overflow-x-auto scrollbar-hide pb-2 mask-linear">
                <button 
                    class="filter-btn group px-4 py-2 rounded-full border transition-all duration-300 whitespace-nowrap text-[10px] md:text-xs uppercase tracking-widest"
                    data-tag="all"
                    data-active-class="bg-hyle-text text-[#F9F8F6] border-hyle-text"
                    data-inactive-class="bg-transparent text-hyle-text/60 border-hyle-text/20 hover:border-hyle-clay hover:text-hyle-clay"
                >
                    Все
                </button>

                {uniqueTags.map(tag => (
                    <button 
                        class="filter-btn group px-4 py-2 rounded-full border transition-all duration-300 whitespace-nowrap text-[10px] md:text-xs uppercase tracking-widest"
                        data-tag={tag.id} 
                        data-active-class="bg-hyle-text text-[#F9F8F6] border-hyle-text"
                        data-inactive-class="bg-transparent text-hyle-text/60 border-hyle-text/20 hover:border-hyle-clay hover:text-hyle-clay"
                    >
                        #{tag.title}
                    </button>
                ))}
            </div>
        </div>

        <!-- PRODUCTS GRID -->
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-8 md:gap-x-8 md:gap-y-16 min-h-[50vh]">
            
            {sortedProducts.map((product) => {
                // Безопасное получение ID категории и Тегов для дата-атрибутов
                const catId = (product.data.category && typeof product.data.category === 'object') 
                    ? product.data.category.id 
                    : product.data.category;
                
                // Собираем теги для JS-фильтрации (нужны ID)
                const tagsList = (product.data.tags || []).map(t => (typeof t === 'object' ? t.id : t));
                const tagsString = tagsList.join(',');
                
                return (
                    <div 
                        class="product-item transition-all duration-700 opacity-100 translate-y-0"
                        data-tags={tagsString}
                    >
                        <ProductCard 
                            product={product} 
                            categoryName={catId ? categoryMap[catId] : ''} 
                        />
                    </div>
                );
            })}

            <div id="empty-state" class="hidden col-span-full py-20 text-center">
                <p class="font-serif text-2xl text-hyle-text/40 mb-4">Ничего не найдено</p>
                <button id="reset-filters" class="text-xs uppercase tracking-widest border-b border-hyle-clay text-hyle-clay">
                    Сбросить
                </button>
            </div>

        </div>

    </div>
  </div>
</Layout>

<script>
    document.addEventListener('astro:page-load', () => {
        initCatalog();
    }, { once: false });

    if (document.readyState === 'complete') {
        initCatalog();
    } else {
        window.addEventListener('load', initCatalog);
    }

    function initCatalog() {
        const buttons = document.querySelectorAll('.filter-btn');
        const items = document.querySelectorAll('.product-item');
        const emptyState = document.getElementById('empty-state');
        const resetBtn = document.getElementById('reset-filters');

        if (!buttons.length || !items.length) return;

        const updateButtons = (activeTag) => {
            buttons.forEach(btn => {
                const isActive = btn.getAttribute('data-tag') === activeTag;
                const activeClass = btn.getAttribute('data-active-class');
                const inactiveClass = btn.getAttribute('data-inactive-class');

                if (isActive) {
                    btn.className = `filter-btn px-4 py-2 rounded-full border transition-all duration-300 whitespace-nowrap text-[10px] md:text-xs uppercase tracking-widest ${activeClass}`;
                } else {
                    btn.className = `filter-btn px-4 py-2 rounded-full border transition-all duration-300 whitespace-nowrap text-[10px] md:text-xs uppercase tracking-widest ${inactiveClass}`;
                }
            });
        };

        const filterGrid = (tag) => {
            let visibleCount = 0;

            items.forEach((item) => {
                const itemTags = item.getAttribute('data-tags')?.split(',') || [];
                const shouldShow = tag === 'all' || itemTags.includes(tag);
                const element = item as HTMLElement;

                if (shouldShow) {
                    element.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        element.style.opacity = '1';
                        element.style.transform = 'translateY(0)';
                    });
                    visibleCount++;
                } else {
                    element.style.opacity = '0';
                    element.style.transform = 'translateY(20px)';
                    element.classList.add('hidden');
                }
            });

            if (visibleCount === 0 && emptyState) {
                emptyState.classList.remove('hidden');
            } else if (emptyState) {
                emptyState.classList.add('hidden');
            }
        };

        const applyFilter = (tag) => {
            updateButtons(tag);
            filterGrid(tag);
            
            const url = new URL(window.location.href);
            if (tag === 'all') {
                url.searchParams.delete('tag');
            } else {
                url.searchParams.set('tag', tag);
            }
            window.history.pushState({}, '', url);
        };

        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const tag = btn.getAttribute('data-tag') || 'all';
                applyFilter(tag);
            });
        });

        if (resetBtn) {
            resetBtn.addEventListener('click', () => applyFilter('all'));
        }

        const params = new URLSearchParams(window.location.search);
        const initialTag = params.get('tag') || 'all';
        updateButtons(initialTag);
        if (initialTag !== 'all') {
            filterGrid(initialTag);
        } else {
            updateButtons('all');
        }
    }
</script>