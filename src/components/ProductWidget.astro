---
// src/components/ProductWidget.astro
import { getEntry } from 'astro:content';

interface Props {
  // FIX: –ü—Ä–∏–Ω–∏–º–∞–µ–º 'item', —Ç–∞–∫ –∫–∞–∫ –≤ –±–∞–∑–µ –∑–∞–ø–∏—Å–∞–Ω–æ item="slug"
  item: string; 
}

const { item: productId } = Astro.props;

// 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
let productEntry = null;

if (productId && typeof productId === 'string') {
    try {
        productEntry = await getEntry('products', productId);
    } catch (e) {
        console.warn(`ProductWidget: –¢–æ–≤–∞—Ä '${productId}' –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
    }
}

// 2. DEBUG MODE (–í–†–ï–ú–ï–ù–ù–û)
// –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∫—Ä–∏—á–∏–º –æ–± —ç—Ç–æ–º, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –≤ –≤–µ—Ä—Å—Ç–∫–µ
if (!productEntry) {
    return (
        <div class="my-8 p-4 border-2 border-red-500 bg-red-50 text-red-700 font-mono text-sm not-prose">
            <strong>üö® WIDGET ERROR:</strong><br/>
            Product with slug <code>"{productId}"</code> not found in DB.<br/>
            Check if the product exists and is published.
        </div>
    );
}

const { title, price, images, status } = productEntry.data;
const mainImage = images && images.length > 0 ? images[0] : '/images/placeholder.jpg';
const formattedPrice = price > 0 ? `${price.toLocaleString('ru-RU')} ‚ÇΩ` : '–ü–æ –∑–∞–ø—Ä–æ—Å—É';
const isSold = status === 'sold' || status === '–ø—Ä–æ–¥–∞–Ω–æ';
---

<!-- WIDGET CONTAINER -->
<div class="my-12 w-full max-w-2xl mx-auto not-prose">
    <div class="relative flex flex-col sm:flex-row bg-hyle-surface border border-hyle-text/5 rounded-sm overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-500">
        
        <!-- Image (Left) -->
        <a href={`/products/${productEntry.slug}`} class="block w-full sm:w-1/3 aspect-[4/3] sm:aspect-auto relative group overflow-hidden">
            <img 
                src={mainImage} 
                alt={title} 
                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
            />
            {isSold && (
                <div class="absolute inset-0 bg-white/40 flex items-center justify-center">
                    <span class="text-[10px] uppercase tracking-widest bg-white px-2 py-1 font-mono">–ü—Ä–æ–¥–∞–Ω–æ</span>
                </div>
            )}
        </a>

        <!-- Content (Right) -->
        <div class="flex-1 p-6 flex flex-col justify-between items-start gap-4">
            <div>
                <span class="font-mono text-[10px] uppercase tracking-widest text-hyle-text/40 mb-2 block">
                    –£–ø–æ–º—è–Ω—É—Ç–æ –≤ —Å—Ç–∞—Ç—å–µ
                </span>
                <a href={`/products/${productEntry.slug}`} class="block">
                    <h3 class="font-serif text-xl md:text-2xl text-hyle-text leading-tight hover:text-hyle-clay transition-colors">
                        {title}
                    </h3>
                </a>
            </div>

            <div class="w-full flex items-end justify-between border-t border-hyle-text/5 pt-4 mt-2">
                <div class="flex flex-col">
                    <span class="font-hand text-2xl text-hyle-clay -rotate-2 origin-left">
                        {formattedPrice}
                    </span>
                </div>

                <a 
                    href={`/products/${productEntry.slug}`} 
                    class="group flex items-center gap-2 font-mono text-[11px] uppercase tracking-widest text-hyle-text hover:text-hyle-clay transition-colors"
                >
                    –°–º–æ—Ç—Ä–µ—Ç—å
                    <span class="text-lg font-serif italic relative top-[-1px] group-hover:translate-x-1 transition-transform">‚Üí</span>
                </a>
            </div>
        </div>

    </div>
</div>