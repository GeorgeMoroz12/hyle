---
// src/pages/catalog.astro
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import { getCollection, getEntries } from 'astro:content';

// 1. ЗАГРУЗКА СПРАВОЧНИКОВ
const allCategories = await getCollection('categories');
const allTags = await getCollection('tags');

// Словари ID -> Title
const categoryMap = allCategories.reduce((acc, cat) => {
    acc[cat.id] = cat.data.title; // ВАЖНО: title
    return acc;
}, {} as Record<string, string>);

const tagMap = allTags.reduce((acc, tag) => {
    acc[tag.id] = tag.data.title; // ВАЖНО: title
    return acc;
}, {} as Record<string, string>);

// Helper
const resolveId = (item: any) => {
    if (!item) return null;
    if (typeof item === 'string') return item;
    if (typeof item === 'object' && item.id) return item.id; // или .slug
    return null;
};

// 2. ТОВАРЫ
const allProducts = await getCollection('products', ({ data }) => {
    return data.status !== 'archived';
});
const sortedProducts = allProducts.sort((a, b) => 0);

// 3. СБОР ФИЛЬТРОВ
// Собираем используемые ID
const usedCategoryIds = new Set(sortedProducts.map(p => resolveId(p.data.category)).filter(Boolean));
const usedTagIds = new Set(sortedProducts.flatMap(p => {
    const tags = p.data.tags || [];
    return tags.map(resolveId).filter(Boolean);
}));

// Формируем массивы для кнопок
const filterCategories = allCategories
    .filter(cat => usedCategoryIds.has(cat.id))
    .map(cat => ({ id: cat.id, title: cat.data.title }))
    .sort((a, b) => a.title.localeCompare(b.title));

// Теги: если есть в базе - берем title, иначе ID
let filterTags = [];
// Превращаем Set в массив ID
const uniqueTagIdsArr = [...usedTagIds];

filterTags = uniqueTagIdsArr.map(id => {
    const title = tagMap[id] || (id.charAt(0).toUpperCase() + id.slice(1));
    return { id, title };
}).sort((a, b) => a.title.localeCompare(b.title));

const pageTitle = "Каталог";
const pageDesc = "Полная коллекция керамики ручной работы Hyle.";
---

<Layout title={pageTitle} description={pageDesc}>
  
  <div class="min-h-screen pt-20 md:pt-24 pb-20 bg-[#FDFCF8]">
    <div class="container-main">
        
        <div class="flex flex-col items-start gap-3 md:gap-4 mb-8 md:mb-12 animate-appear">
            <h1 class="font-serif text-4xl md:text-5xl lg:text-7xl text-hyle-text leading-[0.9]">
                Коллекция
            </h1>
            <p class="text-hyle-text/60 font-light max-w-md mt-1 text-sm md:text-base">
                Все изделия, доступные к заказу.
            </p>
        </div>

        <!-- FILTERS -->
        <div class="sticky top-0 z-40 bg-[#FDFCF8]/95 backdrop-blur-sm py-4 mb-8 md:mb-12 border-b border-hyle-text/5 transition-all w-full" id="filter-bar">
            
            <div class="flex flex-col gap-4">
                <!-- CATEGORIES -->
                <div class="flex items-center gap-4 overflow-x-auto scrollbar-hide pb-1 mask-linear">
                    <button class="filter-btn group pb-1 transition-all duration-300 whitespace-nowrap text-base font-serif" data-type="category" data-value="all" data-active-class="text-hyle-text border-b-2 border-hyle-clay" data-inactive-class="text-hyle-text/40 hover:text-hyle-clay border-b-2 border-transparent">Все</button>
                    {filterCategories.map(cat => (
                        <button class="filter-btn group pb-1 transition-all duration-300 whitespace-nowrap text-base font-serif" data-type="category" data-value={cat.id} data-active-class="text-hyle-text border-b-2 border-hyle-clay" data-inactive-class="text-hyle-text/40 hover:text-hyle-clay border-b-2 border-transparent">{cat.title}</button>
                    ))}
                </div>

                <!-- TAGS -->
                {filterTags.length > 0 && (
                    <div class="flex items-center gap-2 overflow-x-auto scrollbar-hide pb-1">
                        {filterTags.map(tag => (
                            <button class="filter-btn group px-3 py-1 rounded-full border transition-all duration-300 whitespace-nowrap text-[10px] uppercase tracking-widest font-mono" data-type="tag" data-value={tag.id} data-active-class="bg-hyle-text text-[#F9F8F6] border-hyle-text" data-inactive-class="bg-transparent text-hyle-text/50 border-hyle-text/10 hover:border-hyle-clay hover:text-hyle-clay">#{tag.title}</button>
                        ))}
                    </div>
                )}
            </div>
            
            <div id="active-filters-info" class="hidden mt-3 text-[10px] font-mono text-hyle-text/40 flex gap-2 items-center">
                <button id="reset-all" class="underline hover:text-hyle-clay cursor-pointer">Сбросить фильтры</button>
            </div>
        </div>

        <!-- GRID -->
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-8 md:gap-x-8 md:gap-y-16 min-h-[50vh]">
            {sortedProducts.map((product) => {
                const catId = resolveId(product.data.category);
                const rawTags = product.data.tags || [];
                const tagIds = rawTags.map(resolveId).filter(Boolean);
                const tagsString = tagIds.join(',');
                const catName = catId ? (categoryMap[catId] || '') : ''; // Russian Title
                
                return (
                    <div class="product-item transition-all duration-700 opacity-100 translate-y-0" data-category={catId} data-tags={tagsString}>
                        <ProductCard product={product} categoryName={catName} />
                    </div>
                );
            })}
            <div id="empty-state" class="hidden col-span-full py-20 text-center">
                <p class="font-serif text-2xl text-hyle-text/40 mb-4">Здесь пока пусто</p>
                <button onclick="document.getElementById('reset-all').click()" class="text-xs uppercase tracking-widest border-b border-hyle-clay text-hyle-clay">Показать всё</button>
            </div>
        </div>
    </div>
  </div>
</Layout>
<!-- Scripts... -->