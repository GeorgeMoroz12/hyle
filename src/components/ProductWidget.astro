---
import { getEntry } from 'astro:content';

interface Props {
  item: string;
}

const { item: productId } = Astro.props;

// 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
let productEntry = null;
let productData = null;

if (productId && typeof productId === 'string') {
    try {
        productEntry = await getEntry('products', productId);
        if (productEntry) {
            productData = productEntry.data;
        }
    } catch (e) {
        console.warn(`ProductWidget: –¢–æ–≤–∞—Ä '${productId}' –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
    }
}

// 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è —à–∞–±–ª–æ–Ω–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω)
const mainImage = productData?.images?.[0] || '/images/placeholder.jpg';
const formattedPrice = productData?.price 
    ? `${productData.price.toLocaleString('ru-RU')} ‚ÇΩ` 
    : '–ü–æ –∑–∞–ø—Ä–æ—Å—É';

const isSold = productData?.status === 'sold' || productData?.status === '–ø—Ä–æ–¥–∞–Ω–æ';
---

{/* –í–ê–†–ò–ê–ù–¢ –ê: –û–®–ò–ë–ö–ê (–¢–æ–≤–∞—Ä–∞ –Ω–µ—Ç) */}
{ !productEntry && (
    <div class="my-8 p-4 border-2 border-red-500 bg-red-50 text-red-700 font-mono text-sm not-prose">
        <strong>üö® WIDGET ERROR:</strong><br/>
        Product with slug <code>"{productId}"</code> not found in DB.<br/>
        Check if the product exists and is published.
    </div>
)}

{/* –í–ê–†–ò–ê–ù–¢ –ë: –£–°–ü–ï–• (–¢–æ–≤–∞—Ä –µ—Å—Ç—å) */}
{ productEntry && productData && (
    <div class="my-12 w-full max-w-2xl mx-auto not-prose">
        <div class="relative flex flex-col sm:flex-row bg-white border border-black/5 rounded-sm overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-500">

            {/* –ö–∞—Ä—Ç–∏–Ω–∫–∞ (–°–ª–µ–≤–∞) */}
            <a href={`/products/${productEntry.slug}`} class="block w-full sm:w-1/3 aspect-[4/3] sm:aspect-auto relative group overflow-hidden">
                <img
                    src={mainImage}
                    alt={productData.title}
                    class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                />
                {isSold && (
                    <div class="absolute inset-0 bg-white/40 flex items-center justify-center">
                        <span class="text-[10px] uppercase tracking-widest bg-white px-2 py-1 font-mono">–ü—Ä–æ–¥–∞–Ω–æ</span>
                    </div>
                )}
            </a>

            {/* –ö–æ–Ω—Ç–µ–Ω—Ç (–°–ø—Ä–∞–≤–∞) */}
            <div class="flex-1 p-6 flex flex-col justify-between items-start gap-4">
                <div>
                    <span class="font-mono text-[10px] uppercase tracking-widest text-black/40 mb-2 block">
                        –£–ø–æ–º—è–Ω—É—Ç–æ –≤ —Å—Ç–∞—Ç—å–µ
                    </span>
                    <a href={`/products/${productEntry.slug}`} class="block">
                        <h3 class="font-serif text-xl md:text-2xl text-black leading-tight hover:text-orange-600 transition-colors">
                            {productData.title}
                        </h3>
                    </a>
                </div>

                <div class="w-full flex items-end justify-between border-t border-black/5 pt-4 mt-2">
                    <div class="flex flex-col">
                        <span class="font-hand text-2xl text-orange-600 -rotate-2 origin-left">
                            {formattedPrice}
                        </span>
                    </div>

                    <a
                        href={`/products/${productEntry.slug}`}
                        class="group flex items-center gap-2 font-mono text-[11px] uppercase tracking-widest text-black hover:text-orange-600 transition-colors"
                    >
                        –°–º–æ—Ç—Ä–µ—Ç—å
                        <span class="text-lg font-serif italic relative top-[-1px] group-hover:translate-x-1 transition-transform">‚Üí</span>
                    </a>
                </div>
            </div>

        </div>
    </div>
)}