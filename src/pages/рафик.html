<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage Director Pro</title>
    
    <!-- Подключаем React и ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Подключаем Babel для работы JSX прямо в браузере -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Подключаем Tailwind CSS для красоты -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Кастомный скроллбар для списков */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }
        body {
            overflow: hidden; /* Чтобы не скроллилась вся страница */
        }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-100 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS (SVG COMPNENTS) ---
        // Встраиваем иконки прямо сюда, чтобы ничего не ломалось
        const IconBase = ({ d, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {d}
            </svg>
        );

        const Play = (p) => <IconBase {...p} d={<polygon points="5 3 19 12 5 21 5 3"></polygon>} />;
        const Pause = (p) => <IconBase {...p} d={<><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></>} />;
        const Plus = (p) => <IconBase {...p} d={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />;
        const Trash2 = (p) => <IconBase {...p} d={<><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>} />;
        const Mic = (p) => <IconBase {...p} d={<><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></>} />;
        const Upload = (p) => <IconBase {...p} d={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>} />;
        const Volume2 = (p) => <IconBase {...p} d={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></>} />;
        const ArrowUp = (p) => <IconBase {...p} d={<><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></>} />;
        const ArrowDown = (p) => <IconBase {...p} d={<><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></>} />;
        const Power = (p) => <IconBase {...p} d={<><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></>} />;
        const FileText = (p) => <IconBase {...p} d={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>} />;
        const AlertCircle = (p) => <IconBase {...p} d={<><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>} />;
        const RefreshCw = (p) => <IconBase {...p} d={<><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></>} />;
        const Copy = (p) => <IconBase {...p} d={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></>} />;
        const Check = (p) => <IconBase {...p} d={<polyline points="20 6 9 17 4 12"></polyline>} />;
        const Music = (p) => <IconBase {...p} d={<><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></>} />;
        const Users = (p) => <IconBase {...p} d={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></>} />;
        const User = (p) => <IconBase {...p} d={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></>} />;
        const X = (p) => <IconBase {...p} d={<><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>} />;
        const ChevronRight = (p) => <IconBase {...p} d={<polyline points="9 18 15 12 9 6"></polyline>} />;
        const Skull = (p) => <IconBase {...p} d={<><circle cx="9" cy="12" r="1"></circle><circle cx="15" cy="12" r="1"></circle><path d="M8 20v2h8v-2"></path><path d="M12.5 17l.5-2 .5 2"></path><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"></path></>} />;

        // --- CONFIGURATION ---
        const PROMO_VARIANTS = {
            neutral: [
                "На сцену выходит {name}. Встречайте!",
                "Следующая участница — {name}. Ваши аплодисменты!",
                "Для вас танцует {name}. Наслаждайтесь шоу.",
                "Приветствуем на сцене: очаровательная {name}!",
                "Встречайте, {name}!"
            ],
            hot: [
                "На сцену выходит {name} — горячая, яркая, сегодня она зажжёт зал!",
                "Осторожно, становится жарко! {name} уже здесь!",
                "Готовы к настоящему шоу? {name} растопит ваши сердца!",
                "Эта девушка знает, как управлять вашими желаниями. {name}!",
                "Её энергетика сносит с ног. Встречайте — {name}!"
            ],
            bold: [
                "Дерзкая, стильная, неповторимая {name}!",
                "Королева этой ночи — {name}!",
                "Она здесь, чтобы нарушать правила. {name}!",
                "Специально для ценителей прекрасного — {name}!",
                "Ваши самые смелые фантазии воплощаются. {name}!"
            ]
        };

        const DEFAULT_SCHEDULE = [
            { id: 1, time: "22:00", title: "Разогрев", duration: 60, reqType: "none" },
            { id: 2, time: "23:00", title: "Промоушен (Подпевка)", duration: 30, reqType: "promotion" },
            { id: 3, time: "23:30", title: "Белый танец", duration: 15, reqType: "white_dance" },
            { id: 4, time: "23:45", title: "Оргия", duration: 60, reqType: "orgy" },
        ];

        const DEFAULT_PARTICIPANTS = [
            { id: 'p1', name: 'Алиса', stageName: 'Alice', active: true, count: 0, lastPerf: 0 },
            { id: 'p2', name: 'Марина', stageName: 'Roxy', active: true, count: 0, lastPerf: 0 },
            { id: 'p3', name: 'Кристина', stageName: 'Kris', active: true, count: 0, lastPerf: 0 },
            { id: 'p4', name: 'Ева', stageName: 'Eva', active: true, count: 0, lastPerf: 0 },
            { id: 'p5', name: 'Соня', stageName: 'Sonya', active: true, count: 0, lastPerf: 0 },
        ];

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const getShiftMinutes = (timeStr) => {
            if (!timeStr || typeof timeStr !== 'string') return 0;
            try {
                const parts = timeStr.split(':').map(Number);
                if (parts.length < 2 || isNaN(parts[0]) || isNaN(parts[1])) return 0;
                let h = parts[0];
                const m = parts[1];
                if (h < 12) h += 24;
                return h * 60 + m;
            } catch (e) {
                return 0;
            }
        };

        const normalizeTimeStr = (raw) => {
            if (!raw || typeof raw !== 'string') return null;
            let clean = raw.trim().replace(/[\.\s-]/g, ':');
            if (!clean.includes(':') && clean.length === 4 && !isNaN(clean)) {
                clean = clean.slice(0, 2) + ':' + clean.slice(2);
            }
            if (!/^\d{1,2}:\d{2}$/.test(clean)) return null;
            const [h, m] = clean.split(':');
            return `${h.padStart(2, '0')}:${m}`;
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-slate-800 border border-slate-700 rounded-xl overflow-hidden shadow-sm ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ children, color = "slate" }) => {
            const colors = {
                slate: "bg-slate-700 text-slate-300",
                green: "bg-green-500/10 text-green-400 border border-green-500/20",
                red: "bg-red-500/10 text-red-400 border border-red-500/20",
                blue: "bg-cyan-500/10 text-cyan-400 border border-cyan-500/20",
                yellow: "bg-yellow-500/10 text-yellow-400 border border-yellow-500/20",
            };
            return <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${colors[color] || colors.slate}`}>{children}</span>;
        };

        // --- APP COMPONENT ---
        function App() {
            const [now, setNow] = useState(new Date());
            const [testMode, setTestMode] = useState(false);
            const [testTime, setTestTime] = useState("22:00");
            
            const [participants, setParticipants] = useState(DEFAULT_PARTICIPANTS);
            const [schedule, setSchedule] = useState(DEFAULT_SCHEDULE);

            const [currentPerformerId, setCurrentPerformerId] = useState(null);
            const [isPaused, setIsPaused] = useState(true);
            const [elapsedTime, setElapsedTime] = useState(0);
            const timerDuration = 180;

            const [promoText, setPromoText] = useState("Выберите участницу...");
            const [newParticipantName, setNewParticipantName] = useState("");
            const [showImportModal, setShowImportModal] = useState(false);
            const [importText, setImportText] = useState("");
            
            const timerIntervalRef = useRef(null);

            // Init Load
            useEffect(() => {
                try {
                    const p = localStorage.getItem('sd_participants_v3');
                    if (p) setParticipants(JSON.parse(p));
                    
                    const s = localStorage.getItem('sd_schedule_v3');
                    if (s) {
                        const parsedS = JSON.parse(s);
                        if (Array.isArray(parsedS) && parsedS.length > 0) setSchedule(parsedS);
                    }
                } catch (e) { console.error(e); }
            }, []);

            // Save
            useEffect(() => {
                try {
                    localStorage.setItem('sd_participants_v3', JSON.stringify(participants));
                    localStorage.setItem('sd_schedule_v3', JSON.stringify(schedule));
                } catch (e) {}
            }, [participants, schedule]);

            // Clock
            useEffect(() => {
                if (testMode) {
                    const [h, m] = testTime.split(':').map(Number);
                    const d = new Date();
                    if (!isNaN(h)) d.setHours(h);
                    if (!isNaN(m)) d.setMinutes(m);
                    d.setSeconds(0);
                    setNow(d);
                } else {
                    const interval = setInterval(() => setNow(new Date()), 1000);
                    return () => clearInterval(interval);
                }
            }, [testMode, testTime]);

            // Timer
            useEffect(() => {
                if (timerIntervalRef.current) clearInterval(timerIntervalRef.current);
                if (!isPaused && currentPerformerId) {
                    timerIntervalRef.current = setInterval(() => {
                        setElapsedTime(prev => prev + 1);
                    }, 1000);
                }
                return () => { if (timerIntervalRef.current) clearInterval(timerIntervalRef.current); };
            }, [isPaused, currentPerformerId]);

            const currentPerformer = useMemo(() => participants.find(p => p.id === currentPerformerId), [participants, currentPerformerId]);
            const nextPerformer = useMemo(() => participants.find(p => p.active && p.id !== currentPerformerId), [participants, currentPerformerId]);
            const totalActive = participants.filter(p => p.active).length;
            const freePool = Math.max(0, totalActive - 2);

            const currentBlock = useMemo(() => {
                try {
                    if (!schedule || schedule.length === 0) return { title: "Нет расписания", time: "--:--", reqType: "none", duration: 0 };
                    
                    const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const nowMins = getShiftMinutes(timeStr);
                    const sorted = [...schedule].sort((a,b) => getShiftMinutes(a.time) - getShiftMinutes(b.time));

                    if (nowMins < getShiftMinutes(sorted[0].time)) {
                        return { title: `Скоро: ${sorted[0].title}`, time: sorted[0].time, reqType: "none", duration: 0, isWaiting: true };
                    }

                    let active = sorted[0];
                    for (let i = 0; i < sorted.length; i++) {
                        if (nowMins >= getShiftMinutes(sorted[i].time)) active = sorted[i];
                    }
                    return active;
                } catch (e) { return { title: "Ошибка", time: "--:--", reqType: "none", duration: 0 }; }
            }, [now, schedule]);

            const fallbackStatus = useMemo(() => {
                const type = (currentBlock.reqType || "none").toLowerCase();
                const needed = 8;
                const hasEnough = freePool >= needed;
                if (type.includes("promotion") || type.includes("orgy")) {
                    if (!hasEnough) return { isFallback: true, displayTitle: "NON-STOP (Автозамена)", msg: `Мало: ${freePool}/${needed}`, color: "yellow" };
                }
                return { isFallback: false, displayTitle: currentBlock.title || "...", msg: "Штатный режим", color: "green" };
            }, [currentBlock, freePool]);

            const status = useMemo(() => {
                if (fallbackStatus.isFallback) return { ok: true, label: "РЕЖИМ", msg: "Авто-замена на Нон-стоп", color: "yellow" };
                const type = (currentBlock.reqType || "none").toLowerCase();
                if (type.includes("promotion")) return { ok: true, label: "ПРОМОУШЕН", msg: "Состав готов", color: "green" };
                if (type.includes("orgy")) return { ok: true, label: "ОРГИЯ", msg: "Состав готов", color: "green" };
                if (type.includes("white")) return { ok: true, label: "БЕЛЫЙ ТАНЕЦ", msg: "Без лимитов", color: "blue" };
                return { ok: true, label: "СВОБОДНЫЙ", msg: "Штатный", color: "slate" };
            }, [currentBlock, fallbackStatus]);

            const generatePromoText = (performerName) => {
                if (!performerName) return;
                const allVariants = [...PROMO_VARIANTS.neutral, ...PROMO_VARIANTS.hot, ...PROMO_VARIANTS.bold];
                const randomTpl = allVariants[Math.floor(Math.random() * allVariants.length)];
                setPromoText(randomTpl.replace("{name}", performerName));
            };

            useEffect(() => {
                const target = currentPerformer || nextPerformer;
                if (target) generatePromoText(target.stageName);
            }, [currentPerformerId, nextPerformer?.id]);

            const handleStart = () => {
                if (!currentPerformerId) {
                    if (nextPerformer) {
                        setCurrentPerformerId(nextPerformer.id);
                        setElapsedTime(0);
                        setIsPaused(false);
                    } else alert("Нет активных участниц!");
                } else setIsPaused(false);
            };

            const handleFinish = () => {
                if (currentPerformerId) {
                    setParticipants(prev => {
                        const current = prev.find(p => p.id === currentPerformerId);
                        const others = prev.filter(p => p.id !== currentPerformerId);
                        if (!current) return prev;
                        return [...others, { ...current, count: (current.count || 0) + 1, lastPerf: Date.now() }];
                    });
                }
                setCurrentPerformerId(null);
                setElapsedTime(0);
                setIsPaused(true);
            };

            const moveParticipant = (index, direction) => {
                if (index < 0 || index >= participants.length) return;
                const newArr = [...participants];
                if (direction === 'up' && index > 0) [newArr[index], newArr[index - 1]] = [newArr[index - 1], newArr[index]];
                else if (direction === 'down' && index < newArr.length - 1) [newArr[index], newArr[index + 1]] = [newArr[index + 1], newArr[index]];
                setParticipants(newArr);
            };

            const toggleActive = (id) => setParticipants(prev => prev.map(p => p.id === id ? { ...p, active: !p.active } : p));
            
            const addParticipant = () => {
                if (!newParticipantName.trim()) return;
                const newP = { id: generateId(), name: newParticipantName, stageName: newParticipantName, active: true, count: 0, lastPerf: 0 };
                setParticipants([...participants, newP]);
                setNewParticipantName("");
            };

            const hardReset = () => {
                if (confirm("ЭТО СБРОСИТ ВСЕ НАСТРОЙКИ. Вы уверены?")) {
                    localStorage.removeItem('sd_participants_v3');
                    localStorage.removeItem('sd_schedule_v3');
                    window.location.reload();
                }
            };

            const processImportText = (text) => {
                try {
                    const rows = text.trim().split('\n').filter(r => r.trim() !== "");
                    let rawItems = [];
                    rows.forEach((row) => {
                        const cols = row.split(/[\t;]| {2,}/).map(c => c.trim().replace(/^"|"$/g, ''));
                        if (cols.length < 2) return;
                        const time = normalizeTimeStr(cols[0]);
                        const title = cols[1];
                        if (!time) return;
                        let reqType = "none";
                        const lowerTitle = title.toLowerCase();
                        if (lowerTitle.includes("промо") || lowerTitle.includes("подпев")) reqType = "promotion";
                        else if (lowerTitle.includes("оргия")) reqType = "orgy";
                        else if (lowerTitle.includes("белый")) reqType = "white_dance";
                        rawItems.push({ time, title, reqType });
                    });

                    if (rawItems.length === 0) { alert("Не удалось распознать ни одной строки."); return; }
                    rawItems.sort((a, b) => getShiftMinutes(a.time) - getShiftMinutes(b.time));

                    const newSchedule = rawItems.map((item, index) => {
                        let duration = 60;
                        if (index < rawItems.length - 1) {
                            const nextItem = rawItems[index + 1];
                            const startMins = getShiftMinutes(item.time);
                            const endMins = getShiftMinutes(nextItem.time);
                            duration = endMins - startMins;
                        }
                        if (duration < 0 || isNaN(duration)) duration = 30;
                        return { id: generateId(), time: item.time, title: item.title, reqType: item.reqType, duration: duration };
                    });

                    setSchedule(newSchedule);
                    setShowImportModal(false);
                    setImportText("");
                    alert(`Загружено ${newSchedule.length} строк.`);
                } catch (e) { alert("Ошибка при чтении."); }
            };

            const formatTime = (s) => `${Math.floor(s / 60).toString().padStart(2,'0')}:${(s % 60).toString().padStart(2,'0')}`;

            return (
                <div className="flex flex-col h-full overflow-hidden">
                    <header className={`h-16 border-b flex items-center justify-between px-6 shrink-0 transition-colors duration-500 ${status.color === 'yellow' ? 'bg-yellow-900/20 border-yellow-900/50' : status.color === 'red' ? 'bg-red-900/20 border-red-900/50' : 'bg-slate-800 border-slate-700'}`}>
                        <div className="flex items-center gap-4">
                            <div className="bg-cyan-600 p-2 rounded-lg shadow-lg shadow-cyan-500/20"><Volume2 size={24} className="text-white" /></div>
                            <div>
                                <h1 className="font-bold text-lg tracking-wider text-white">DJ ASSISTANT <span className="text-cyan-400">PRO</span></h1>
                                <div className="flex items-center gap-2 text-xs text-slate-400">
                                    <span className={status.color === 'yellow' ? "text-yellow-400 font-bold" : status.ok ? "text-green-400" : "text-red-400 font-bold"}>{status.label}: {status.msg}</span>
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-6">
                            <div className="flex bg-slate-900/80 rounded-lg p-1 border border-slate-700">
                                <div className="px-4 py-1 text-center border-r border-slate-700">
                                    <div className="text-[10px] text-slate-500 uppercase font-bold">Актив</div>
                                    <div className="text-xl font-mono font-bold text-white">{totalActive}</div>
                                </div>
                                <div className="px-4 py-1 text-center border-r border-slate-700 bg-slate-800/50">
                                    <div className="text-[10px] text-slate-500 uppercase font-bold">-2 Буфер</div>
                                    <div className="text-xs font-mono text-slate-400">-2</div>
                                </div>
                                <div className="px-4 py-1 text-center">
                                    <div className="text-[10px] text-slate-500 uppercase font-bold">Свободно</div>
                                    <div className={`text-xl font-mono font-bold ${freePool < 8 && !fallbackStatus.isFallback ? 'text-red-500 animate-pulse' : 'text-green-400'}`}>{freePool}</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex flex-col items-end">
                                    {testMode ? (
                                        <div className="flex items-center gap-2 bg-yellow-500/10 px-2 py-1 rounded border border-yellow-500/40">
                                            <span className="text-[10px] text-yellow-500 font-bold uppercase animate-pulse">Тест</span>
                                            <input type="time" value={testTime} onChange={(e) => setTestTime(e.target.value)} className="bg-slate-900 text-white font-mono text-xl rounded border border-slate-600 px-1 w-28 focus:outline-none focus:border-yellow-500" />
                                            <button onClick={() => setTestMode(false)} className="text-slate-400 hover:text-white bg-slate-800 rounded p-0.5"><X size={16}/></button>
                                        </div>
                                    ) : (
                                        <div className="text-3xl font-mono font-bold text-white tracking-tight cursor-pointer hover:text-cyan-400 transition" onClick={() => setTestMode(true)} title="Ввод времени вручную">
                                            {now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                    )}
                                    {!testMode && <div className="text-[10px] text-slate-500">Системное время</div>}
                                </div>
                                <button onClick={hardReset} className="p-2 text-slate-600 hover:text-red-500 transition" title="Сброс"><Skull size={20} /></button>
                            </div>
                        </div>
                    </header>

                    <div className="flex-1 grid grid-cols-12 gap-0 overflow-hidden min-h-0">
                        <div className="col-span-4 bg-[#1e293b] border-r border-slate-700 flex flex-col p-4 gap-4 h-full min-h-0">
                            <Card className="flex-1 flex flex-col relative bg-gradient-to-b from-slate-800 to-slate-900 min-h-0">
                                <div className="absolute top-4 left-4 right-4 flex justify-between items-start z-10">
                                    <Badge color={!isPaused ? "red" : "slate"}>{!isPaused ? "LIVE" : "PAUSED"}</Badge>
                                    <div className="text-right flex flex-col items-end">
                                        <div className="text-3xl font-mono font-bold text-white leading-none mb-1">{currentBlock.time}</div>
                                        <div className="text-xs text-slate-400 font-bold uppercase truncate max-w-[200px] text-right">{fallbackStatus.displayTitle}</div>
                                        {fallbackStatus.isFallback && <div className="text-[10px] text-yellow-500 font-bold bg-yellow-900/30 px-2 rounded mt-1">{fallbackStatus.msg}</div>}
                                    </div>
                                </div>
                                <div className="flex-1 flex flex-col items-center justify-center p-6 pt-12 z-10 min-h-0 overflow-hidden">
                                    {currentPerformer ? (
                                        <>
                                            <div className="w-24 h-24 rounded-full bg-slate-700 mb-4 flex items-center justify-center shadow-2xl border-4 border-slate-600 shrink-0"><User size={48} className="text-slate-500" /></div>
                                            <h2 className="text-3xl font-black text-white mb-1 tracking-tight text-center leading-none truncate max-w-full px-2">{currentPerformer.stageName}</h2>
                                            <div className={`text-6xl font-mono font-bold mb-6 tabular-nums ${elapsedTime > timerDuration ? 'text-red-500 animate-pulse' : 'text-cyan-400'}`}>{formatTime(elapsedTime)}</div>
                                            <div className="flex gap-3 w-full shrink-0">
                                                {isPaused ? 
                                                    <button onClick={() => setIsPaused(false)} className="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-xl text-white font-bold transition flex flex-col items-center justify-center gap-1"><Play size={20} /><span className="text-[10px] uppercase opacity-70">Продолжить</span></button> :
                                                    <button onClick={() => setIsPaused(true)} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-bold transition flex flex-col items-center justify-center gap-1"><Pause size={20} /><span className="text-[10px] uppercase opacity-70">Пауза</span></button>
                                                }
                                                <button onClick={handleFinish} className="flex-1 py-3 bg-cyan-600 hover:bg-cyan-500 rounded-xl text-white font-bold transition shadow-lg shadow-cyan-500/20 flex flex-col items-center justify-center gap-1"><Check size={20} /><span className="text-[10px] uppercase opacity-70">Завершить</span></button>
                                            </div>
                                        </>
                                    ) : (
                                        <div className="text-center opacity-40">
                                            <div className="flex justify-center mb-4"><Music size={64} /></div>
                                            <p className="text-xl font-bold">Сцена свободна</p>
                                            <button onClick={handleStart} className="mt-6 px-8 py-3 bg-cyan-600 text-white rounded-lg font-bold hover:bg-cyan-500 transition">Начать блок</button>
                                        </div>
                                    )}
                                </div>
                                {!isPaused && <div className="absolute inset-0 bg-cyan-500/5 animate-pulse pointer-events-none"></div>}
                            </Card>
                            <div className="bg-slate-800 rounded-lg p-3 px-4 border border-slate-700 flex justify-between items-center shadow-lg shrink-0">
                                <div className="text-xs text-slate-500 uppercase font-bold flex items-center gap-2"><ChevronRight size={16} className="text-cyan-400" /> Готовится</div>
                                <div className="font-bold text-white text-lg">{nextPerformer ? nextPerformer.stageName : "—"}</div>
                            </div>
                            <Card className="h-40 bg-slate-800 p-4 flex flex-col shrink-0">
                                <div className="flex justify-between items-center mb-2">
                                    <div className="flex items-center gap-2 text-cyan-400 font-bold text-sm uppercase tracking-wider"><Mic size={16} /> Текст MC</div>
                                    <button onClick={() => generatePromoText(currentPerformer?.stageName || nextPerformer?.stageName)} className="p-1 hover:bg-slate-700 rounded text-slate-400 hover:text-white transition"><RefreshCw size={14} /></button>
                                </div>
                                <div className="flex-1 bg-slate-900/50 rounded-lg p-3 border border-slate-700/50 mb-2 overflow-y-auto flex items-center justify-center">
                                    <p className="text-base text-slate-200 leading-snug font-medium text-center">"{promoText}"</p>
                                </div>
                                <div className="flex justify-between items-center text-[10px] text-slate-500">
                                    <span>Для: {currentPerformer?.stageName || nextPerformer?.stageName || "..."}</span>
                                    <button className="flex items-center gap-1 hover:text-cyan-400 transition" onClick={() => {navigator.clipboard.writeText(promoText)}}><Copy size={10} /> Копировать</button>
                                </div>
                            </Card>
                        </div>

                        <div className="col-span-5 bg-[#0f172a] p-4 flex flex-col border-r border-slate-800 h-full min-h-0">
                            <div className="flex justify-between items-center mb-4 shrink-0">
                                <h3 className="font-bold text-white flex items-center gap-2"><Users size={18} className="text-slate-400" /> Очередь</h3>
                                <div className="flex gap-2">
                                    <input className="bg-slate-800 border border-slate-700 rounded px-3 py-1.5 text-sm text-white focus:outline-none focus:border-cyan-500 w-32" placeholder="Имя..." value={newParticipantName} onChange={e => setNewParticipantName(e.target.value)} onKeyDown={e => e.key === 'Enter' && addParticipant()} />
                                    <button onClick={addParticipant} className="bg-slate-700 hover:bg-slate-600 text-white p-1.5 rounded"><Plus size={18} /></button>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-2 min-h-0">
                                {participants.map((p, index) => {
                                    const isCurrent = p.id === currentPerformerId;
                                    return (
                                        <div key={p.id} className={`group relative flex items-center gap-3 p-3 rounded-xl border transition-all duration-200 ${isCurrent ? 'bg-cyan-900/20 border-cyan-500/50 shadow-[0_0_15px_rgba(6,182,212,0.1)]' : 'bg-slate-800/80 border-slate-700 hover:border-slate-500'} ${!p.active ? 'opacity-50 grayscale' : ''}`}>
                                            <div className="w-6 text-center font-mono text-xs text-slate-500 font-bold">{index + 1}</div>
                                            <div className="flex flex-col gap-0.5">
                                                <button onClick={() => moveParticipant(index, 'up')} disabled={index === 0} className="text-slate-600 hover:text-cyan-400 disabled:opacity-0 p-0.5"><ArrowUp size={14}/></button>
                                                <button onClick={() => moveParticipant(index, 'down')} disabled={index === participants.length - 1} className="text-slate-600 hover:text-cyan-400 disabled:opacity-0 p-0.5"><ArrowDown size={14}/></button>
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                    <span className={`font-bold truncate ${isCurrent ? 'text-cyan-400 text-lg' : 'text-slate-200'}`}>{p.stageName}</span>
                                                    {isCurrent && <span className="text-[10px] bg-cyan-500 text-white px-1 rounded animate-pulse">ON AIR</span>}
                                                </div>
                                                <div className="text-xs text-slate-500 flex gap-3"><span>{p.name}</span><span>• Выходов: {p.count || 0}</span></div>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <button onClick={() => toggleActive(p.id)} className={`p-2 rounded-lg transition-colors ${p.active ? 'bg-green-500/10 text-green-400 hover:bg-green-500/20' : 'bg-slate-700 text-slate-500'}`} title={p.active ? "В работе" : "Отдыхает"}><Power size={16} /></button>
                                                {p.active && !isCurrent && <button onClick={() => { setCurrentPerformerId(p.id); setElapsedTime(0); setIsPaused(false); }} className="p-2 bg-slate-700 hover:bg-cyan-600 text-slate-300 hover:text-white rounded-lg transition-colors" title="На сцену!"><Play size={16} /></button>}
                                                <button onClick={() => confirm("Удалить?") && setParticipants(prev => prev.filter(x => x.id !== p.id))} className="p-2 text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition"><Trash2 size={16} /></button>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>

                        <div className="col-span-3 bg-slate-900 border-l border-slate-800 flex flex-col h-full min-h-0">
                            <div className="p-4 border-b border-slate-800 bg-slate-800/50 shrink-0">
                                <h3 className="font-bold text-slate-400 text-xs uppercase mb-3 flex items-center gap-2"><FileText size={14} /> Расписание</h3>
                                <button onClick={() => setShowImportModal(true)} className="w-full py-2 border-2 border-dashed border-slate-600 rounded-lg text-slate-400 text-xs font-bold hover:border-cyan-500 hover:text-cyan-400 transition flex items-center justify-center gap-2"><Upload size={14} /> Загрузить из Excel</button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 min-h-0">
                                {schedule.map(block => {
                                    const isActive = currentBlock.id === block.id;
                                    const nowMins = getShiftMinutes(now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
                                    const blockMins = getShiftMinutes(block.time);
                                    const isPast = !isActive && blockMins < nowMins;
                                    return (
                                        <div key={block.id} className={`p-3 rounded-lg border text-sm ${isActive ? 'bg-cyan-900/10 border-cyan-500/30' : 'bg-transparent border-slate-800'} ${isPast ? 'opacity-40' : ''}`}>
                                            <div className="flex justify-between mb-1">
                                                <span className={`font-mono font-bold ${isActive ? 'text-cyan-400' : 'text-slate-400'}`}>{block.time}</span>
                                                <span className="text-[10px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-500">{block.duration} мин</span>
                                            </div>
                                            <div className="font-bold text-slate-200">{block.title}</div>
                                            {block.reqType !== 'none' && <div className="mt-2 flex items-center gap-1.5 text-[10px] text-slate-500 bg-slate-800/50 p-1 rounded"><AlertCircle size={10} />{block.reqType === 'promotion' ? 'Мин. 8 своб.' : block.reqType === 'orgy' ? 'Мин. 8 своб.' : 'Без лимита'}</div>}
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    </div>

                    {showImportModal && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-700 rounded-xl p-6 max-w-2xl w-full shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-white flex items-center gap-2"><FileText size={24} className="text-cyan-400"/> Импорт (Copy-Paste)</h3>
                                    <button onClick={() => setShowImportModal(false)} className="text-slate-500 hover:text-white"><X size={24}/></button>
                                </div>
                                <div className="mb-4 bg-slate-900/50 p-4 rounded border border-slate-700/50">
                                    <h4 className="font-bold text-white mb-2">Как пользоваться:</h4>
                                    <ol className="list-decimal list-inside text-sm text-slate-400 space-y-1">
                                        <li>Откройте Excel таблицу.</li>
                                        <li>Выделите два столбца: <b>Время</b> и <b>Название</b>.</li>
                                        <li>Скопируйте (Ctrl+C).</li>
                                        <li>Вставьте сюда (Ctrl+V).</li>
                                    </ol>
                                </div>
                                <textarea className="w-full h-48 bg-slate-900 border border-slate-700 rounded p-3 text-xs text-white font-mono focus:outline-none focus:border-cyan-500 mb-6" placeholder="22:00\tОткрытие\n22:30\tПервый выход" value={importText} onChange={(e) => setImportText(e.target.value)} />
                                <div className="flex justify-end gap-3">
                                    <button onClick={() => setShowImportModal(false)} className="px-4 py-2 text-slate-400 hover:text-white">Отмена</button>
                                    <button onClick={() => processImportText(importText)} disabled={!importText.trim()} className="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 disabled:opacity-50 text-white rounded font-bold transition">Рассчитать и Загрузить</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>