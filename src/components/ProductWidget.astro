---
import { getEntry } from 'astro:content';

// 1. –ü—Ä–∏–Ω–∏–º–∞–µ–º –ø—Ä–æ–ø (–≤ –±–∞–∑–µ –æ–Ω –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è item)
const { item } = Astro.props;

// 2. –õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
let productEntry = null;
let productData = null;

// –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω ID
if (item && typeof item === 'string') {
    try {
        productEntry = await getEntry('products', item);
        if (productEntry) {
            productData = productEntry.data;
        }
    } catch (e) {
        console.warn(`ProductWidget Error: ${e.message}`);
    }
}

// 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–µ—Ä—Å—Ç–∫–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
const mainImage = productData?.images?.[0] || '/images/placeholder.jpg';
const formattedPrice = productData?.price ? `${productData.price} ‚ÇΩ` : '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É';
const isSold = productData?.status === 'sold' || productData?.status === '–ø—Ä–æ–¥–∞–Ω–æ';
const slug = productEntry?.slug || '#';
---

{/* –í–ê–†–ò–ê–ù–¢ 1: –¢–û–í–ê–† –ù–ï –ù–ê–ô–î–ï–ù (–í—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏) */}
{ !productData && (
    <div class="my-8 p-4 border-2 border-red-500 bg-red-50 text-red-700 font-mono text-sm not-prose">
        <strong>üö® WIDGET ERROR:</strong><br/>
        –¢–æ–≤–∞—Ä —Å ID <code>"{item}"</code> –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.<br/>
        –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —É–∫–∞–∑–∞–Ω slug –≤ –∞–¥–º–∏–Ω–∫–µ.
    </div>
)}

{/* –í–ê–†–ò–ê–ù–¢ 2: –¢–û–í–ê–† –ù–ê–ô–î–ï–ù (–†–∏—Å—É–µ–º –∫–∞—Ä—Ç–æ—á–∫—É) */}
{ productData && (
    <div class="my-12 w-full max-w-2xl mx-auto not-prose">
        <div class="relative flex flex-col sm:flex-row bg-white border border-black/5 rounded-sm overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-500">

            {/* –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –ö–∞—Ä—Ç–∏–Ω–∫–∞ */}
            <a href={`/products/${slug}`} class="block w-full sm:w-1/3 aspect-[4/3] sm:aspect-auto relative group overflow-hidden">
                <img
                    src={mainImage}
                    alt={productData.title}
                    class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                />
                {isSold && (
                    <div class="absolute inset-0 bg-white/40 flex items-center justify-center">
                        <span class="text-[10px] uppercase tracking-widest bg-white px-2 py-1 font-mono">–ü—Ä–æ–¥–∞–Ω–æ</span>
                    </div>
                )}
            </a>

            {/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ö–æ–Ω—Ç–µ–Ω—Ç */}
            <div class="flex-1 p-6 flex flex-col justify-between items-start gap-4">
                <div>
                    <span class="font-mono text-[10px] uppercase tracking-widest text-black/40 mb-2 block">
                        –£–ø–æ–º—è–Ω—É—Ç–æ –≤ —Å—Ç–∞—Ç—å–µ
                    </span>
                    <a href={`/products/${slug}`} class="block">
                        <h3 class="font-serif text-xl md:text-2xl text-black leading-tight hover:text-orange-600 transition-colors">
                            {productData.title}
                        </h3>
                    </a>
                </div>

                <div class="w-full flex items-end justify-between border-t border-black/5 pt-4 mt-2">
                    <span class="font-hand text-2xl text-orange-600 -rotate-2 origin-left">
                        {formattedPrice}
                    </span>

                    <a href={`/products/${slug}`} class="group flex items-center gap-2 font-mono text-[11px] uppercase tracking-widest text-black hover:text-orange-600 transition-colors">
                        –°–º–æ—Ç—Ä–µ—Ç—å
                        <span class="text-lg font-serif italic relative top-[-1px] group-hover:translate-x-1 transition-transform">‚Üí</span>
                    </a>
                </div>
            </div>

        </div>
    </div>
)}