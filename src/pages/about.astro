---
// src/pages/about.astro
import Layout from '../layouts/Layout.astro';
import { getEntry } from 'astro:content';

// 1. ПОЛУЧЕНИЕ ДАННЫХ ИЗ CMS
let entry = null;
let Content = null;
let cmsData = null;

try {
    entry = await getEntry('about', 'main');
    if (entry) {
        const rendered = await entry.render();
        Content = rendered.Content;
        cmsData = entry.data;
    }
} catch (e) {
    console.warn('CMS: About page content missing or invalid.', e);
}

// 2. ХЕЛПЕР ДЛЯ КАРТИНОК (NATIVE PATH RESOLVER)
// Задача: Превратить любой ввод (имя файла, объект, путь) в строку, начинающуюся с /images/
const resolveImage = (img: any) => {
    if (!img) return null;
    
    // Вариант А: Если Keystatic вернул объект (редко, но бывает)
    if (typeof img === 'object') {
        if (img.src) return img.src; // Astro Image Metadata
        return null;
    }
    
    // Вариант Б: Строка
    if (typeof img === 'string') {
        // Если это внешний URL (https://...) — оставляем
        if (img.startsWith('http')) return img;
        
        // Если путь уже абсолютный (/images/pic.jpg) — оставляем
        if (img.startsWith('/')) return img;
        
        // Если это просто имя файла (pic.jpg) или относительный путь (./pic.jpg)
        // Чистим от ./ и добавляем префикс папки public
        const cleanName = img.replace(/^(\.\/)/, ''); 
        return `/images/${cleanName}`;
    }
    
    return null;
};

// Фоллбэки
const FALLBACK_IMG = "https://images.unsplash.com/photo-1565193566173-092e7f246457?q=80&w=1000&auto=format&fit=crop";
const LOCAL_FALLBACK = "/images/workshop-process.jpg";

// Обрабатываем то, что пришло из базы
const rawImage = cmsData?.image; 
const processedImage = resolveImage(rawImage);

// Логируем для отладки на сервере
if (rawImage) {
    console.log(`[About Page] Raw image from CMS: "${rawImage}"`);
    console.log(`[About Page] Resolved path: "${processedImage}"`);
}

const DATA = {
    // Приоритет: 1. Обработанный путь из CMS -> 2. Локальная заглушка
    image: processedImage || LOCAL_FALLBACK,
    title: cmsData?.title || '"Я верю, что вещи должны замедлять время."',
    est: cmsData?.est || "Est. 2026",
    location: cmsData?.location || "Moscow, RU",
    fallbackHTML: `
        <p>Привет. Меня зовут [Имя Мастера], и я создаю керамику Hyle.</p>
        <p>В мире, где всё стремится стать идеальным и одинаковым, я ищу красоту в случайностях. След пальца на ручке чашки, неровный край тарелки — всё это делает предмет живым.</p>
        <p>Моя керамика — это тактильный опыт. Это вес глины в руке, шероховатость терракоты и гладкость эмали.</p>
    `
};
---

<Layout title="О мастере" description="Философия Hyle Ceramics. О мастере и процессе создания.">
  
  <div class="min-h-screen pt-32 pb-20 bg-[#FDFCF8]">
    <div class="container-main">
        
        <div class="mb-16 md:mb-24 animate-appear">
            <span class="font-mono text-[10px] uppercase tracking-[0.3em] text-hyle-text/40 pl-1 block mb-4">
                The Maker
            </span>
            <h1 class="font-serif text-5xl md:text-7xl text-hyle-text leading-[0.9]">
                О мастерской
            </h1>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-20 items-start">
            
            <!-- LEFT: IMAGE -->
            <div class="lg:col-span-5 relative animate-appear" style="animation-delay: 100ms;">
                <div class="relative aspect-[4/5] overflow-hidden rounded-sm bg-neutral-100 shadow-xl">
                    <!-- NATIVE IMG TAG: Без оптимизации Astro, прямой доступ к public -->
                    <img 
                        src={DATA.image} 
                        alt="Портрет мастера" 
                        class="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-[1.5s]"
                        /* Fallback на внешний URL, если файл физически не найден */
                        onerror={`this.onerror=null; this.src='${FALLBACK_IMG}';`}
                    />
                    <div class="absolute inset-0 border border-white/20 m-4 pointer-events-none"></div>
                </div>
                
                <div class="mt-4 flex flex-col gap-1 font-mono text-[10px] text-hyle-text/40 uppercase tracking-widest">
                    <div class="flex justify-between">
                        <span>{DATA.est}</span>
                        <span>{DATA.location}</span>
                    </div>
                    
                    {/* Debug info visible only in dev if image is broken/missing but path exists */}
                    {import.meta.env.DEV && rawImage && (
                        <div class="mt-2 p-2 bg-gray-100 border border-gray-300 text-gray-500 normal-case tracking-normal">
                            Dev Debug: <br/>
                            CMS: {JSON.stringify(rawImage)} <br/>
                            Src: {DATA.image}
                        </div>
                    )}
                </div>
            </div>

            <!-- RIGHT: TEXT -->
            <div class="lg:col-span-7 lg:pl-12 flex flex-col gap-10 animate-appear" style="animation-delay: 200ms;">
                
                <h2 class="font-serif text-3xl md:text-4xl text-hyle-text leading-tight">
                    {DATA.title}
                </h2>

                <div class="prose prose-stone prose-lg font-light text-hyle-text/70 leading-relaxed space-y-6 prose-p:my-4 prose-a:text-hyle-clay prose-a:no-underline hover:prose-a:underline">
                    {Content ? <Content /> : <Fragment set:html={DATA.fallbackHTML} />}
                </div>

                <div class="mt-8 pt-8 border-t border-hyle-text/10">
                    <p class="font-hand text-3xl text-hyle-text/80 -rotate-2">
                        С любовью, Hyle.
                    </p>
                </div>

                <div class="flex flex-col gap-4 mt-4">
                    <span class="font-mono text-[10px] uppercase tracking-widest text-hyle-text/40">Контакты</span>
                    <a href="https://t.me/username" target="_blank" class="text-lg hover:text-hyle-clay transition-colors border-b border-hyle-text/20 pb-1 w-max">
                        Написать в Telegram →
                    </a>
                </div>

            </div>

        </div>
    </div>
  </div>
</Layout>