---
// src/pages/index.astro
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import Footer from '../components/Footer.astro';
import { getCollection, getEntry } from 'astro:content';

const landingEntry = await getEntry('landing', 'home');
const data = landingEntry?.data || {};

const FALLBACK_HERO = "/images/hero-minimal.jpg";
const FALLBACK_WORKSHOP = "/images/workshop-process.jpg";

const HERO = {
    image: data.heroImage || FALLBACK_HERO,
    titleLine1: data.heroTitleLine1 || "Глина",
    titleAccent: data.heroTitleAccent || "хранит",
    titleLine2: data.heroTitleLine2 || "тепло.",
    description: data.heroDescription || "Посуда, созданная в тишине. С несовершенствами, которые делают ее живой."
};

const WORKSHOP = {
    image: data.workshopImage || FALLBACK_WORKSHOP,
    title: data.workshopTitle || "Красота в несовершенстве.",
    text: data.workshopText || "В блоге мы делимся процессом: как бесформенный кусок глины обретает характер."
};

const allProducts = await getCollection('products');
const recentProducts = allProducts.slice(0, 8); 

const allCategories = await getCollection('categories');
const categoryMap = allCategories.reduce((acc, cat) => {
    acc[cat.id] = cat.data.title;
    return acc;
}, {} as Record<string, string>);

const tgUsername = import.meta.env.PUBLIC_TG_USERNAME || 'hyle_ceramics';
const tgLink = `https://t.me/${tgUsername}`;
---

<Layout title="Главная" hideHeader={true}>
  
  <!-- MOBILE MENU -->
  <div id="mobile-menu" class="fixed inset-0 bg-hyle-bg z-[100] translate-x-full transition-transform duration-500 ease-out flex flex-col justify-center items-center text-center text-hyle-text">
      <button id="close-menu" class="absolute top-8 right-6 text-hyle-text/50 hover:text-hyle-text uppercase tracking-widest text-[10px] border-b border-transparent hover:border-current transition-colors pb-1 cursor-pointer">
          Закрыть
      </button>
      
      <nav class="flex flex-col gap-10 font-serif text-4xl">
          <a href="/catalog" class="hover:text-hyle-clay transition-colors italic">Каталог</a>
          <a href="/about" class="hover:text-hyle-clay transition-colors italic">О мастере</a>
          <a href="/blog" class="hover:text-hyle-clay transition-colors italic">Журнал</a>
      </nav>

      <div class="mt-16 flex gap-8 font-mono text-[10px] uppercase tracking-widest text-hyle-text/30">
          <a href={tgLink} target="_blank" class="hover:text-hyle-text transition-colors">Telegram</a>
      </div>
  </div>

  <!-- HEADER -->
  <nav class="absolute top-0 left-0 w-full z-50 px-5 py-6 md:px-12 md:py-8 flex justify-between items-start text-white pointer-events-none">
      <a href="/" class="group flex flex-col gap-0.5 pointer-events-auto">
          <span class="font-serif text-3xl md:text-4xl leading-none block drop-shadow-md">Hyle.</span>
          <span class="font-sans text-[10px] md:text-[11px] tracking-wider pl-0.5 opacity-90 hidden sm:block">
              керамика ручной работы
          </span>
      </a>
      
      <div class="hidden md:flex gap-12 font-sans text-[13px] tracking-wide font-medium pointer-events-auto">
          <a href="/catalog" class="hover:opacity-70 transition-opacity drop-shadow-sm">каталог</a>
          <a href="/about" class="hover:opacity-70 transition-opacity drop-shadow-sm">о мастере</a>
          <a href="/blog" class="hover:opacity-70 transition-opacity drop-shadow-sm">журнал</a>
      </div>

      <button id="open-menu" class="md:hidden pt-1.5 text-[10px] uppercase tracking-[0.2em] border-b border-white/60 pb-0.5 drop-shadow-sm font-sans pointer-events-auto cursor-pointer">
          меню
      </button>
  </nav>

  <!-- HERO SECTION -->
  <section id="hero-section" class="relative min-h-[90vh] md:min-h-screen w-full flex flex-col justify-end pb-16 md:pb-24 overflow-hidden bg-[#1a1918]">
    <div class="absolute inset-0 z-0">
        <img 
            id="hero-image"
            src={HERO.image} 
            alt="Атмосфера" 
            class="w-full h-full object-cover scale-105 transition-transform duration-[2.5s] ease-out will-change-transform"
            onerror={`this.onerror=null; this.src='${FALLBACK_HERO}';`}
        />
        <div class="absolute inset-0 bg-black/30 md:bg-black/40"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>
    </div>

    <div class="container-main relative z-10 w-full">
        <div class="animate-appear flex flex-col md:block items-start">
            
            <!-- MAIN TITLE: CLASSIC SERIF (Playfair) -->
            <h1 class="flex flex-col leading-[0.9] md:leading-[0.85] tracking-tight select-none text-white font-serif mb-6 md:mb-10">
                <!-- Строка 1 -->
                <span class="text-[16vw] md:text-[9rem] lg:text-[11rem] opacity-90 block">
                    {HERO.titleLine1.toLowerCase()}
                </span>
                
                <!-- Строка 2 (С акцентом Caveat) -->
                <span class="text-[16vw] md:text-[9rem] lg:text-[11rem] ml-4 md:ml-32 -mt-1 md:-mt-8 flex flex-wrap items-baseline gap-4 md:gap-8 opacity-90">
                    <span class="font-hand text-4xl md:text-7xl text-[#e0d0c0] opacity-100 -rotate-3 relative top-[-5px] md:top-[-15px] transform translate-y-[-1vw]">
                        {HERO.titleAccent.toLowerCase()}
                    </span>
                    {HERO.titleLine2.replace('.', '').toLowerCase()}
                </span>
            </h1>

            <div class="flex flex-col md:flex-row justify-between items-start md:items-end w-full gap-8 md:pl-2">
                <p class="font-sans font-light text-base md:text-xl text-white/90 max-w-[280px] md:max-w-sm leading-relaxed border-l border-white/30 pl-4 md:pl-6">
                    {HERO.description}
                </p>
                <a href="/catalog" class="group flex items-center gap-3 cursor-pointer pb-2 md:pb-0 pointer-events-auto">
                    <span class="font-mono text-xs uppercase tracking-[0.2em] text-white border-b border-white/40 pb-1 group-hover:border-white transition-all">
                        В каталог
                    </span>
                    <span class="text-xl text-white group-hover:translate-x-2 transition-transform duration-300 font-serif italic">→</span>
                </a>
            </div>
        </div>
    </div>
  </section>

  <!-- CATALOG SECTION -->
  <section class="py-16 md:py-32 bg-hyle-bg text-hyle-text relative z-20 overflow-hidden rounded-t-[24px] md:rounded-t-[40px] -mt-6 md:-mt-12 shadow-[0_-20px_60px_rgba(0,0,0,0.1)] transition-colors duration-500">
    <div class="container-main">
        <div class="flex flex-col md:flex-row justify-between items-end mb-10 md:mb-16 gap-4">
            <div class="max-w-lg">
                <span class="font-sans text-[10px] uppercase tracking-[0.2em] text-hyle-text/40 block mb-2">Избранное</span>
                <h2 class="font-serif text-3xl md:text-5xl text-hyle-text">
                    Новое из печи
                </h2>
            </div>
            <div class="hidden md:flex items-center gap-2 text-hyle-text/30">
                <span class="font-sans text-[10px] uppercase tracking-[0.2em]">Листайте</span>
                <span class="text-lg">→</span>
            </div>
        </div>
        <div id="horizontal-showcase" class="flex gap-4 md:gap-8 overflow-x-auto pb-12 px-5 -mx-5 md:px-0 md:mx-0 snap-x md:snap-none cursor-ew-resize scrollbar-hide overscroll-x-contain">
            {recentProducts.map((product, idx) => {
                const catId = (product.data.category && typeof product.data.category === 'object') ? product.data.category.id : product.data.category;
                const offsetClass = idx % 2 !== 0 ? "mt-0 md:mt-12" : "";
                return (
                    <div class={`shrink-0 w-[75vw] md:w-[450px] snap-center transition-transform duration-700 hover:-translate-y-2 ${offsetClass}`}>
                         <ProductCard product={product} categoryName={catId ? categoryMap[catId] : ''} />
                    </div>
                );
            })}
            <div class="shrink-0 w-[40vw] md:w-[200px] flex items-center justify-center snap-center md:snap-align-none">
                 <a href="/catalog" class="group flex flex-col items-center gap-3 text-hyle-text/40 hover:text-hyle-clay transition-colors">
                    <span class="text-3xl font-serif italic group-hover:translate-x-1 transition-transform">→</span>
                    <span class="font-mono text-[10px] md:text-xs uppercase tracking-[0.2em] border-b border-transparent group-hover:border-hyle-clay">все изделия</span>
                 </a>
            </div>
            <div class="w-4 shrink-0"></div>
        </div>
    </div>
  </section>

  <!-- UNIFIED DARK SECTION: WORKSHOP + FOOTER -->
  <div class="bg-[#1F1E1C] text-[#F9F8F6] relative overflow-hidden">
      <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] mix-blend-overlay pointer-events-none"></div>
      
      <section class="py-16 md:py-40 relative z-10">
          <div class="container-main grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-32 items-center">
              <div class="relative order-1 lg:order-1 pl-0 lg:pl-0">
                  <div class="group relative z-10 aspect-[4/5] overflow-hidden rounded-sm w-full md:w-[90%] shadow-2xl bg-[#2C2B29]">
                      <img 
                        src={WORKSHOP.image} 
                        alt="Процесс" 
                        class="w-full h-full object-cover transition-all duration-[1.5s] ease-out"
                        onerror={`this.onerror=null; this.src='${FALLBACK_WORKSHOP}';`}
                      />
                  </div>
              </div>
              <div class="order-2 lg:order-2">
                  <span class="font-sans text-[10px] uppercase tracking-[0.2em] text-[#B35A32] mb-4 md:mb-6 block">Философия</span>
                  <h2 class="font-serif text-3xl md:text-5xl mb-6 md:mb-8 leading-tight text-white">
                      {WORKSHOP.title}
                  </h2>
                  <div class="space-y-4 md:space-y-6 text-white/50 font-light text-sm md:text-lg leading-relaxed max-w-md border-l border-white/10 pl-6">
                      <p>{WORKSHOP.text}</p>
                  </div>
                  <div class="mt-8 md:mt-12">
                      <a href="/about" class="group inline-flex items-center gap-3 text-white hover:text-[#B35A32] transition-colors">
                          <span class="font-mono text-xs uppercase tracking-[0.2em] border-b border-white/30 pb-1 group-hover:border-[#B35A32] transition-colors">
                              О мастере
                          </span>
                          <span class="text-lg font-serif italic relative top-[-1px]">→</span>
                      </a>
                  </div>
              </div>
          </div>
      </section>

      <!-- GLOBAL FOOTER -->
      <Footer />
  </div>
</Layout>

<script>
    const openBtn = document.getElementById('open-menu');
    const closeBtn = document.getElementById('close-menu');
    const menu = document.getElementById('mobile-menu');
    if (openBtn && closeBtn && menu) {
        openBtn.addEventListener('click', () => menu.classList.remove('translate-x-full'));
        closeBtn.addEventListener('click', () => menu.classList.add('translate-x-full'));
    }

    const showcase = document.getElementById('horizontal-showcase');
    let target = 0; let current = 0; let isAnimating = false;
    if (showcase) {
        target = showcase.scrollLeft; current = showcase.scrollLeft;
        showcase.addEventListener('wheel', (evt) => {
            if (window.matchMedia("(min-width: 768px)").matches) {
                const maxScroll = showcase.scrollWidth - showcase.clientWidth;
                const canScrollRight = target < maxScroll - 2;
                const canScrollLeft = target > 2;
                if ((evt.deltaY > 0 && canScrollRight) || (evt.deltaY < 0 && canScrollLeft)) {
                    evt.preventDefault();
                    target += evt.deltaY * 2.5;
                    target = Math.max(0, Math.min(target, maxScroll));
                    if (!isAnimating) { isAnimating = true; requestAnimationFrame(smoothScrollLoop); }
                }
            }
        }, { passive: false });
    }
    function smoothScrollLoop() {
        if (!showcase) return;
        current += (target - current) * 0.08;
        showcase.scrollLeft = current;
        if (Math.abs(target - current) > 0.5) { requestAnimationFrame(smoothScrollLoop); } 
        else { isAnimating = false; showcase.scrollLeft = target; }
    }
    
    const heroSection = document.getElementById('hero-section');
    const heroImage = document.getElementById('hero-image');
    if (heroSection && heroImage) {
        heroSection.addEventListener('mousemove', (e) => {
            if (window.matchMedia("(min-width: 1024px)").matches) {
                // @ts-ignore
                const { clientX, clientY } = e;
                const { innerWidth, innerHeight } = window;
                const moveX = (clientX / innerWidth - 0.5) * 15;
                const moveY = (clientY / innerHeight - 0.5) * 15;
                heroImage.style.transform = `translate(${-moveX}px, ${-moveY}px) scale(1.05)`;
            }
        });
    }
</script>